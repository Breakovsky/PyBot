# Makefile –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram –±–æ—Ç–æ–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make <–∫–æ–º–∞–Ω–¥–∞>

SHELL := powershell.exe
.SHELLFLAGS := -NoProfile -Command

VENV_PYTHON = .venv\Scripts\python.exe
MAIN_DIR = main
LOG_FILE = main\bot_log.log

.PHONY: start stop restart status logs install clean help

## start: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
start:
	@Write-Host "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..." -ForegroundColor Cyan
	@cd $(MAIN_DIR); Start-Process -FilePath "..\$(VENV_PYTHON)" -ArgumentList "main.py" -WindowStyle Hidden
	@Start-Sleep -Seconds 2
	@Write-Host "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω" -ForegroundColor Green

## stop: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
stop:
	@Write-Host "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞..." -ForegroundColor Cyan
	@Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
	@Write-Host "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" -ForegroundColor Green

## restart: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
restart: stop
	@Start-Sleep -Seconds 2
	@$(MAKE) start

## status: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
status:
	@$$proc = Get-Process python -ErrorAction SilentlyContinue; if ($$proc) { Write-Host "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $$($$proc.Id))" -ForegroundColor Green } else { Write-Host "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω" -ForegroundColor Red }

## logs: –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
logs:
	@if (Test-Path "$(LOG_FILE)") { Get-Content "$(LOG_FILE)" -Tail 50 } else { Write-Host "‚ùå –õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" -ForegroundColor Red }

## logs-follow: –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
logs-follow:
	@Get-Content "$(LOG_FILE)" -Tail 20 -Wait

## install: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
install:
	@Write-Host "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..." -ForegroundColor Cyan
	@if (-not (Test-Path ".venv")) { python -m venv .venv }
	@$(VENV_PYTHON) -m pip install --upgrade pip
	@$(VENV_PYTHON) -m pip install -r requirements.txt
	@$(VENV_PYTHON) -m pip install tabulate
	@Write-Host "‚úÖ –ì–æ—Ç–æ–≤–æ" -ForegroundColor Green

## clean: –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
clean:
	@Write-Host "üßπ –û—á–∏—Å—Ç–∫–∞..." -ForegroundColor Cyan
	@Get-ChildItem -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
	@Get-ChildItem -Recurse -Filter "*.pyc" | Remove-Item -Force -ErrorAction SilentlyContinue
	@if (Test-Path "bot.pid") { Remove-Item "bot.pid" -Force }
	@Write-Host "‚úÖ –û—á–∏—â–µ–Ω–æ" -ForegroundColor Green

## run: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ç–µ–∫—É—â–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
run:
	@cd $(MAIN_DIR); ..\$(VENV_PYTHON) main.py

## help: –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
help:
	@Write-Host ""
	@Write-Host "ü§ñ Telegram Bot - –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:" -ForegroundColor Cyan
	@Write-Host ""
	@Write-Host "  make start       - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ"
	@Write-Host "  make stop        - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"
	@Write-Host "  make restart     - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
	@Write-Host "  make status      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
	@Write-Host "  make logs        - –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏"
	@Write-Host "  make logs-follow - –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏"
	@Write-Host "  make run         - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (–æ—Ç–ª–∞–¥–∫–∞)"
	@Write-Host "  make install     - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
	@Write-Host "  make clean       - –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à"
	@Write-Host ""

# –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫—É
.DEFAULT_GOAL := help

