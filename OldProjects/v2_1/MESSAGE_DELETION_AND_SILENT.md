# Логика удаления сообщений и Silent сообщения

## Что реализовано

### 1. Silent сообщения (без уведомлений)

**Где используется:**
- Все сообщения бота в Excel топике отправляются с `disable_notification=True`
- Это означает, что пользователи не получат уведомления о результатах поиска

**Преимущества:**
- Не мешает пользователям уведомлениями
- Чистый интерфейс в групповых чатах
- Сообщения все равно видны, но без звука/вибрации

### 2. Логика удаления сообщений (как в старом боте)

#### Задержки удаления:

1. **USER_MESSAGE_DELETE_DELAY = 30 секунд**
   - Сообщения пользователей в обычных топиках (не Excel)
   - Удаляются через 30 секунд после отправки

2. **EXCEL_MESSAGE_DELETE_DELAY = 300 секунд (5 минут)**
   - Сообщения пользователей в Excel топике
   - Ответы бота в Excel топике
   - Удаляются через 5 минут после отправки

3. **BOT_MESSAGE_DELETE_DELAY = 600 секунд (10 минут)**
   - Сообщения бота в других топиках
   - Удаляются через 10 минут после отправки

#### Механизм работы:

1. **Сохранение в БД:**
   - Все сообщения, которые нужно удалить, сохраняются в таблице `telegram.pending_deletions`
   - Хранится: `chat_id`, `topic_id`, `message_id`, `delete_after` (время удаления)

2. **Планирование удаления:**
   - При отправке сообщения создается задача `asyncio.create_task(_delete_message_later(...))`
   - Задача ждет указанное время и удаляет сообщение

3. **Проверка разрешенных топиков:**
   - Удаляются только сообщения из топиков, указанных в `ALLOWED_THREADS`
   - По умолчанию: `38,40,42,164` (можно настроить в БД)

4. **Очистка при запуске:**
   - При запуске бота вызывается `cleanup_excel_topic()`
   - Удаляются все старые сообщения из Excel топика, которые были сохранены в БД
   - Это предотвращает накопление старых сообщений после перезапуска

### 3. Настройки в БД

Все настройки хранятся в таблице `core.settings`:

- `USER_MESSAGE_DELETE_DELAY` - задержка удаления сообщений пользователей (секунды)
- `EXCEL_MESSAGE_DELETE_DELAY` - задержка удаления сообщений в Excel топике (секунды)
- `BOT_MESSAGE_DELETE_DELAY` - задержка удаления сообщений бота (секунды)
- `ALLOWED_THREADS` - разрешенные топики для удаления (через запятую)

### 4. Миграция БД

Создана миграция `002_add_pending_deletions.py`:
- Таблица `telegram.pending_deletions` для отслеживания сообщений на удаление
- Индексы для быстрого поиска
- Уникальное ограничение на `(chat_id, message_id)`

## Как использовать

### Инициализация настроек:

```powershell
.\bot.ps1 init-settings
```

Это создаст/обновит все настройки в БД, включая настройки удаления.

### Применение миграции:

```powershell
.\bot.ps1 migrate
```

Это создаст таблицу `telegram.pending_deletions` в БД.

### Проверка настроек:

```powershell
.\bot.ps1 settings
```

Покажет все текущие настройки, включая задержки удаления.

## Совместимость со старым ботом

Логика полностью совместима со старым ботом:
- ✅ Те же задержки удаления (30 сек, 5 мин, 10 мин)
- ✅ Проверка разрешенных топиков (ALLOWED_THREADS)
- ✅ Silent сообщения в Excel топике
- ✅ Очистка при запуске
- ✅ Сохранение в БД для надежности

## Отличия от старого бота

1. **PostgreSQL вместо SQLite:**
   - Используется PostgreSQL для хранения pending_deletions
   - Более надежное хранение данных

2. **Асинхронные операции:**
   - Все операции с БД асинхронные (asyncpg)
   - Более эффективная работа с БД

3. **Настройки в БД:**
   - Все задержки настраиваются через БД
   - Не нужно перезапускать бота для изменения настроек

