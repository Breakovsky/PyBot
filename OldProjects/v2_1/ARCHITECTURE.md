# Архитектура TBot v2.1

## Обзор

TBot v2.1 - это полностью переработанная версия с production-ready архитектурой, поддержкой кластеризации и современными практиками разработки.

## Ключевые особенности

### 1. База данных PostgreSQL

**Схемы:**
- `core` - основные таблицы (settings, users, audit_log)
- `telegram` - данные Telegram (пользователи, чаты, сообщения)
- `employees` - данные сотрудников (бывший Excel)
- `monitoring` - мониторинг серверов
- `otrs` - интеграция с OTRS
- `cluster` - координация кластера

**Преимущества:**
- Нормализация данных
- Логическое разделение
- Масштабируемость
- Транзакции и ACID

### 2. Кластеризация

**Компоненты:**
- **Leader Election** через Redis
- **Heartbeat** для мониторинга узлов
- **Distributed Locks** для координации задач
- **Shared State** через PostgreSQL

**Сценарии:**
- 2+ сервера с одним ботом
- Автоматический failover
- Распределение нагрузки

### 3. Безопасность

**Хранение секретов:**
- Windows Credential Manager (keyring)
- Секреты не в файлах
- Централизованное управление

**Audit Logging:**
- Все действия пользователей
- Изменения настроек
- Доступ к данным

**Rate Limiting:**
- Защита от злоупотреблений
- Настраиваемые лимиты

### 4. Веб-интерфейс

**Технологии:**
- FastAPI (вместо Flask)
- Async/await
- REST API
- WebSocket (опционально)

**Возможности:**
- Управление сотрудниками (CRUD)
- Управление серверами
- Настройки системы
- Метрики и аналитика
- Audit log просмотр

### 5. Excel → БД

**Структура:**
- `employees.departments` - подразделения
- `employees.workstations` - рабочие станции
- `employees.employees` - сотрудники

**Преимущества:**
- Редактирование через веб
- История изменений
- Поиск и фильтрация
- Валидация данных

## Архитектура компонентов

```
┌─────────────────────────────────────────┐
│         Windows Server 2019            │
│                                         │
│  ┌──────────────┐  ┌──────────────┐   │
│  │  Node 1      │  │  Node 2      │   │
│  │  (Bot)      │  │  (Bot)      │   │
│  └──────┬───────┘  └──────┬───────┘   │
│         │                 │            │
│         └────────┬─────────┘            │
│                  │                      │
│         ┌─────────▼─────────┐          │
│         │   PostgreSQL      │          │
│         │   (Shared DB)     │          │
│         └─────────┬─────────┘          │
│                   │                    │
│         ┌─────────▼─────────┐          │
│         │   Redis/Memurai   │          │
│         │   (Coordination)  │          │
│         └───────────────────┘          │
└─────────────────────────────────────────┘
```

## Потоки данных

### 1. Telegram Bot

```
Telegram API → Bot Handler → Repository → PostgreSQL
                                    ↓
                              Redis (Cache)
```

### 2. Web Admin

```
Browser → FastAPI → Repository → PostgreSQL
                    ↓
              JWT Auth → Audit Log
```

### 3. Background Workers

```
Scheduler → Cluster Coordinator → Leader Check
                ↓
         Task Execution → Repository → PostgreSQL
```

## Репозитории

### EmployeeRepository
- Поиск по имени, телефону, рабочей станции, IP
- CRUD операции
- Валидация данных

### ServerRepository (TODO)
- Управление серверами
- Группы серверов
- Метрики

### OTRSRepository (TODO)
- Интеграция с OTRS
- Тикеты
- Метрики пользователей

## Сервисы

### ClusterCoordinator
- Leader election
- Heartbeat
- Distributed locks
- Node registration

### TelegramBotService (TODO)
- Обработка сообщений
- Команды бота
- Интеграции

### WebAdminService (TODO)
- FastAPI приложение
- REST API
- Веб-интерфейс

### MonitoringService (TODO)
- Проверка серверов
- Метрики
- Уведомления

## Миграции

### Alembic
- Версионирование схемы
- Автоматические миграции
- Откат изменений

### Скрипты миграции
- `migrate_from_sqlite.py` - импорт из SQLite
- `import_excel_to_db.py` - импорт из Excel

## Конфигурация

### Источники:
1. **БД** (`core.settings`) - основные настройки
2. **Windows Credential Manager** - секреты
3. **.env** - только для разработки

### Приоритет:
1. БД (самый высокий)
2. Windows Credential Manager
3. .env (только для разработки)

## Мониторинг

### Health Checks
- `/health` - статус сервисов
- `/metrics` - Prometheus метрики

### Логирование
- Структурированные логи (JSON)
- Ротация логов
- Централизованное логирование (опционально)

## Развертывание

### Требования:
- Python 3.9+
- PostgreSQL 14+
- Redis/Memurai
- Windows Server 2019

### Шаги:
1. Установить PostgreSQL и Redis
2. Создать БД и пользователя
3. Применить миграции
4. Настроить секреты
5. Импортировать данные
6. Запустить сервисы

## Масштабирование

### Горизонтальное:
- Добавление новых узлов
- Load balancing для веб-интерфейса
- Распределение задач

### Вертикальное:
- Увеличение пула соединений
- Оптимизация запросов
- Кэширование

## Безопасность

### Аутентификация:
- JWT токены для API
- Email верификация для Telegram
- Пароли через bcrypt

### Авторизация:
- Роли пользователей
- Права доступа
- Audit logging

### Защита:
- Rate limiting
- Валидация входных данных
- SQL injection защита
- XSS защита

## Производительность

### Оптимизации:
- Connection pooling
- Кэширование (Redis)
- Индексы БД
- Асинхронные операции

### Метрики:
- Время ответа
- Throughput
- Ошибки
- Использование ресурсов

## Дальнейшее развитие

### Планируется:
1. Полная реализация веб-интерфейса
2. WebSocket для real-time обновлений
3. Расширенная аналитика
4. Экспорт отчетов
5. API для внешних систем
6. Webhooks

### Опционально:
1. GraphQL API
2. Kubernetes deployment
3. Микросервисная архитектура
4. Event-driven архитектура



