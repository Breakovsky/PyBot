# Руководство по импорту данных сотрудников из Excel

## Проблема: Поиск не работает

Если поиск в топике Excel не работает, возможны две причины:

1. **В БД нет данных сотрудников** (основная причина)
2. **Неправильно настроен EXCEL_TOPIC_ID**

## Проверка данных

Проверьте, есть ли данные в БД:

```powershell
.\bot.ps1 check-employees
```

Или:

```powershell
python scripts\check_employees.py
```

Если в БД 0 сотрудников, нужно импортировать данные из Excel.

## Импорт данных из Excel

### Подготовка Excel файла

Excel файл должен содержать следующие колонки (названия могут варьироваться):

- **ФИО** (или Имя, Ф.И.О) - обязательное поле
- **Отдел** (или Подразделение) - опционально
- **Рабочая станция** (или WS, Компьютер, PC) - опционально
- **IP адрес** - опционально
- **Телефон** (или Phone) - опционально
- **AD аккаунт** (или Учетная запись, Аккаунт) - опционально
- **Примечания** (или Заметка, Notes) - опционально

### Импорт незащищенного файла

```powershell
python scripts\import_employees.py "путь\к\файлу.xlsx"
```

Пример:

```powershell
python scripts\import_employees.py "C:\Data\employees.xlsx"
```

### Импорт с указанием листа

```powershell
python scripts\import_employees.py "путь\к\файлу.xlsx" --sheet "Лист1"
```

### Импорт защищенного файла (с паролем)

```powershell
python scripts\import_employees.py "путь\к\файлу.xlsx" --password "пароль"
```

### Полный пример

```powershell
python scripts\import_employees.py "C:\Data\employees.xlsx" --sheet "Сотрудники" --password "mypassword"
```

## Как работает импорт

1. Скрипт автоматически определяет колонки по заголовкам
2. Создает отделы, если их нет в БД
3. Создает рабочие станции, если их нет в БД
4. Импортирует или обновляет сотрудников

**Важно:**
- Если сотрудник с таким же ФИО уже существует, данные будут обновлены
- Новые отделы и рабочие станции создаются автоматически
- Пустые строки пропускаются

## Проверка после импорта

После импорта проверьте данные:

```powershell
.\bot.ps1 check-employees
```

Должно показать количество импортированных сотрудников.

## Проверка работы поиска

1. Убедитесь, что EXCEL_TOPIC_ID настроен правильно:

```powershell
.\bot.ps1 settings
```

2. Отправьте `/chatinfo` в нужном топике, чтобы проверить Topic ID

3. Обновите EXCEL_TOPIC_ID если нужно:

```powershell
.\bot.ps1 update-chat
```

4. Перезапустите бота:

```powershell
.\bot.ps1 restart
```

5. Отправьте сообщение в топик Excel (например, имя сотрудника или телефон)

## Troubleshooting

### Ошибка: "Не найдена строка с заголовками"

Убедитесь, что в Excel файле есть строка с заголовками (ФИО, Отдел и т.д.) в первых 20 строках.

### Ошибка: "Не найдена колонка с ФИО"

Проверьте, что в файле есть колонка с названием, содержащим "ФИО", "Имя" или "Ф.И.О".

### Ошибка: "Файл может быть защищен паролем"

Используйте параметр `--password` для защищенных файлов.

### Поиск все еще не работает после импорта

1. Проверьте логи бота:

```powershell
.\bot.ps1 logs
```

2. Убедитесь, что обработчик срабатывает (должны быть записи "Excel topic message received")

3. Проверьте, что Topic ID правильный (используйте `/chatinfo` в топике)

4. Убедитесь, что бот перезапущен после изменения настроек

## Формат данных в БД

После импорта данные хранятся в следующих таблицах:

- `employees.employees` - основная таблица сотрудников
- `employees.departments` - отделы
- `employees.workstations` - рабочие станции

## Пример структуры Excel файла

| ФИО | Отдел | Рабочая станция | IP адрес | Телефон | AD аккаунт | Примечания |
|-----|-------|-----------------|----------|---------|------------|------------|
| Иванов Иван Иванович | IT | WS-001 | 192.168.1.10 | 1234 | ivanov | - |
| Петров Петр Петрович | HR | WS-002 | 192.168.1.11 | 5678 | petrov | - |

## Дополнительная информация

- Скрипт поддерживает автоматическое определение колонок
- Названия колонок могут быть на русском или английском
- Регистр не важен (ФИО = фио = Фио)
- Пустые ячейки обрабатываются корректно

