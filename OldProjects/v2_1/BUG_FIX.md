# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–ª –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏:
```
asyncpg.exceptions.UndefinedTableError: –æ—Ç–Ω–æ—à–µ–Ω–∏–µ "telegram.otrs_users" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

–í –∫–æ–¥–µ `auth_handler.py` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å —Ç–∞–±–ª–∏—Ü–∞ `telegram.otrs_users`, –Ω–æ –≤ –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ `otrs.otrs_users` –≤ —Å—Ö–µ–º–µ `otrs`, –∞ –Ω–µ `telegram`.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î:
- `telegram.telegram_users` - –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö Telegram
- `otrs.otrs_users` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ OTRS (—Å–≤—è–∑—å —á–µ—Ä–µ–∑ `telegram_user_id`)

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –≤ `auth_handler.py`:

1. **`is_authenticated()`** - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç JOIN –º–µ–∂–¥—É `telegram.telegram_users` –∏ `otrs.otrs_users`
2. **`get_user_info()`** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ JOIN'–∞–º–∏
3. **`verify_code()`** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:
   - –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `telegram.telegram_users`
   - –ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `otrs.otrs_users`
4. **`logout()`** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ `otrs.otrs_users`

## üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –î–æ:
```python
SELECT telegram_id FROM telegram.otrs_users WHERE telegram_id = $1
```

### –ü–æ—Å–ª–µ:
```python
SELECT otrs.otrs_users.id 
FROM otrs.otrs_users
JOIN telegram.telegram_users ON otrs.otrs_users.telegram_user_id = telegram.telegram_users.id
WHERE telegram.telegram_users.telegram_id = $1
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ `/start` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ email —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –í—Å–µ SQL-–∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç –¥–æ–ª–∂–µ–Ω:
1. –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/start`
2. –ó–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å email –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

