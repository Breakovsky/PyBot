################################################################################
üìÑ FILE: ./config/backup.sh
################################################################################
#!/bin/bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
echo "Starting backup service..."
echo "Remote path: /remote_backup"

while true; do
    echo "--- Starting backup cycle at $(date) ---"
    
    BACKUP_DIR="/tmp/redmine_backup"
    DATE=$(date +%Y%m%d_%H%M%S)
    REMOTE_PATH="/remote_backup"
    
    # 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    mkdir -p $BACKUP_DIR
    
    # 2. –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º PGPASSWORD –∏–∑ env —Ñ–∞–π–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    pg_dump -h postgres -U postgres -d redmine > $BACKUP_DIR/redmine_db_$DATE.sql
    
    if [ $? -ne 0 ]; then
        echo "ERROR: Database backup FAILED. Retrying in 1 hour."
        rm -rf $BACKUP_DIR
        sleep 3600
        continue
    fi
    
    # 3. –ë—ç–∫–∞–ø —Ñ–∞–π–ª–æ–≤
    mkdir -p $BACKUP_DIR/attachments
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if [ -d "/usr/src/redmine/files" ]; then
        cp -r /usr/src/redmine/files/* $BACKUP_DIR/attachments/ 2>/dev/null || true
    fi

    # 4. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è
    TAR_FILE="redmine_backup_$DATE.tar.gz"
    tar -czf $TAR_FILE -C $BACKUP_DIR .
    
    # 5. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω—ã–π –¥–∏—Å–∫
    cp $TAR_FILE $REMOTE_PATH/
    
    if [ $? -eq 0 ]; then
        echo "SUCCESS: Backup saved to $REMOTE_PATH/$TAR_FILE"
        # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –£–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
        # find $REMOTE_PATH -name "redmine_backup_*.tar.gz" -mtime +7 -delete
    else
        echo "ERROR: Failed to copy backup to remote storage."
    fi
    
    # 6. –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    rm -rf $BACKUP_DIR $TAR_FILE
    
    echo "Cycle finished. Sleeping for 1 hour..."
    sleep 3600
done



################################################################################
üìÑ FILE: ./config/database.yml
################################################################################
production:
  adapter: postgresql
  database: redmine
  host: postgres
  port: 5432
  username: postgres
  password: <%= ENV['REDMINE_DB_PASSWORD'] %>
  encoding: utf8


################################################################################
üìÑ FILE: ./config/email_receive.sh
################################################################################
#!/bin/bash

export PATH="/usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
export RAILS_ENV=production
export LANG=C.UTF-8

cd /usr/src/redmine

RAILS_ENV=production /usr/local/bin/bundle exec /usr/local/bin/rake redmine:email:receive_imap \
    host=email.gpnof.ru \
    port=993 \
    ssl=true \
    username=help@gpnof.ru \
    password='xYk!4!!V-7' \
    project=uh \
    tracker=bug \
    unknown_user=create \
    no_permission_check=1

EXIT_CODE=$?

exit $EXIT_CODE



################################################################################
üìÑ FILE: ./config/nginx.conf
################################################################################
upstream redmine_app {
    server redmine:3000;
}

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ –¥–æ–º–µ–Ω—É (–ø–æ—Ä—Ç 80)
server {
    listen 80;
    server_name redmine.gpnof.local;

    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ (–≤–∞–∂–Ω–æ –¥–ª—è –≤–ª–æ–∂–µ–Ω–∏–π!)
    client_max_body_size 100m;

    location / {
        proxy_pass http://redmine_app;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ –ø–æ—Ä—Ç—É 8081 (–∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏)
server {
    listen 8081;
    # –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ª—é–±—ã–µ –¥–æ–º–µ–Ω—ã –∏–ª–∏ IP –Ω–∞ —ç—Ç–æ–º –ø–æ—Ä—Ç—É
    server_name _;

    client_max_body_size 100m;

    location / {
        proxy_pass http://redmine_app;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}



################################################################################
üìÑ FILE: ./config/supervisord.conf
################################################################################
[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
logfile_maxbytes=10MB
logfile_backups=5
loglevel=info
pidfile=/tmp/supervisord.pid

[program:redmine]
command=/docker-entrypoint.sh passenger start --address 0.0.0.0 --port 3000 --environment production --log-file /dev/stdout
directory=/usr/src/redmine
autostart=true
autorestart=true
startsecs=20
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=RAILS_ENV="production",TZ="Europe/Moscow"

[program:email_receive]
command=/bin/bash -c "while true; do /usr/local/bin/email_receive; sleep 10; done"
directory=/usr/src/redmine
autostart=true
autorestart=true
startsecs=5
stopasgroup=true
killasgroup=true
stdout_logfile=/usr/src/redmine/log/email_receive.log
stderr_logfile=/usr/src/redmine/log/email_receive.error.log
environment=RAILS_ENV="production",LANG="C.UTF-8",TZ="Europe/Moscow"

[program:redmine_email_reports]
command=/bin/bash -c "cd /usr/src/redmine && while true; do sleep $((60 - $(date +%%S))); bundle exec rake email_reports:send_pending RAILS_ENV=production; done"
autostart=true
autorestart=true
startsecs=10
stopasgroup=true
killasgroup=true
stdout_logfile=/usr/src/redmine/log/email_reports.log
stderr_logfile=/usr/src/redmine/log/email_reports.error.log
environment=RAILS_ENV="production",TZ="Europe/Moscow"


################################################################################
üìÑ FILE: ./docker-compose.yml
################################################################################
services:

  nginx:
    container_name: nginx-proxy
    image: nginx:1.26-alpine
    ports:
      - "8081:8081"
      - "8091:80"
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - redmine
    restart: always

  redmine:
    container_name: redmine-production
    build:
      context: .
      dockerfile: Dockerfile
    expose:
      - "3000"
    volumes:
      - ./storage/shared:/usr/src/redmine/shared
      - ./storage/redmine/configuration.yml:/usr/src/redmine/config/configuration.yml      
      - ./storage/redmine/attachment_files:/usr/src/redmine/files
      - ./storage/redmine/plugins:/usr/src/redmine/plugins
      - ./storage/redmine/themes:/usr/src/redmine/themes
      - ./logs/redmine:/usr/src/redmine/log
      - ./logs/supervisor:/var/log/supervisor
    env_file:
      - .env
    environment:
      TZ: "Europe/Moscow"
      REDMINE_DB_POSTGRES: "postgres"
      REDMINE_DB_USERNAME: "postgres"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
    # restart –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω —Å—é–¥–∞ (–Ω–∞ —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä–≤–∏—Å–∞)
    restart: always

  postgres:
    container_name: postgres-production
    image: postgres:18.1
    ports:
      - "5432:5432"
    volumes:
      - ./storage/postgresql-data:/var/lib/postgresql/data
    env_file:
      - .env
    environment:
      PGDATA: "/var/lib/postgresql/data/pgdata"
      POSTGRES_DB: "redmine"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    # restart –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω —Å—é–¥–∞
    restart: always

  backup_redmine:
    container_name: backup_redmine_service
    build:
      context: .
      dockerfile: Dockerfile.backup
    volumes:
      - ./storage/redmine/attachment_files:/usr/src/redmine/files:ro
      - /mnt/win_backup:/remote_backup:rw
    env_file:
      - .env
    depends_on:
      - postgres
    restart: unless-stopped



################################################################################
üìÑ FILE: ./Dockerfile
################################################################################
FROM redmine:6.1.0

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    supervisor \
    nano \
    passenger \
    curl \
    build-essential \
    libcurl4-openssl-dev \
    libssl-dev \
    zlib1g-dev && \
    rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–µ–º–æ–≤
RUN gem install whenever -v '1.0.0' --no-document && \
    gem install chronic -v '0.10.2' --no-document && \
    gem install passenger -v '6.0.23' --no-document && \
    bundle config set without 'development test' && \
    bundle install

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ runtime –¥–ª—è Passenger
RUN passenger-config install-standalone-runtime --auto

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
COPY config/database.yml /usr/src/redmine/config/database.yml

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Supervisor
COPY config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –ø—Ä–∏–µ–º–∞ –ø–æ—á—Ç—ã
COPY config/email_receive.sh /usr/local/bin/email_receive
RUN chmod +x /usr/local/bin/email_receive

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]



################################################################################
üìÑ FILE: ./Dockerfile.backup
################################################################################
FROM alpine:3.22.2

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å postgres –∏ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
RUN apk add --no-cache postgresql-client bash procps tar gzip perl ca-certificates

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞ –≤–Ω—É—Ç—Ä—å –æ–±—Ä–∞–∑–∞
COPY config/backup.sh /usr/local/bin/backup.sh
RUN chmod +x /usr/local/bin/backup.sh

WORKDIR /work

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
CMD ["/usr/local/bin/backup.sh"]



################################################################################
üìÑ FILE: ./.env
################################################################################
REDMINE_DB_PASSWORD=PASSWORD
POSTGRES_PASSWORD=PASSWORD
PGPASSWORD=PASSWORD
IMAP_PASSWORD=xYk!4!!V-7
SMTP_PASSWORD=xYk!4!!V-7
SECRET_KEY_BASE=1b30813e853a4b4499df6c3a863cb5a97e9b26236ddfab3ca5125b62a476dfbf105d748c57844bebd3ba0b2a6dcfea3d23fe251c71fa475d0eff08a628ba230d
REDMINE_BASE_URL=http://redmine.gpnof.local:8091
SMTP_ADDRESS=email.gpnof.ru
SMTP_PORT=587
SMTP_AUTH=login
SMTP_STARTTLS=true
IMAP_HOST=email.gpnof.ru
IMAP_PORT=993
IMAP_SSL=true
IMAP_USERNAME=help@gpnof.ru



################################################################################
üìÑ FILE: ./prod_project.txt
################################################################################



################################################################################
üìÑ FILE: ./run_tasks.sh
################################################################################
#!/bin/bash
echo "--- Run at $(date) ---" >> /opt/tg_bot/cron_debug.log

# –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–£–¢–¨ –ö DOCKER-COMPOSE.YML
cd /opt/tg_bot/redmine/production || { echo "Cd failed to /opt/tg_bot/redmine/production" >> /opt/tg_bot/cron_debug.log; exit 1; }

export PATH=$PATH:/usr/local/bin:/usr/bin:/bin

# –ó–∞–ø—É—Å–∫
/usr/bin/docker compose exec -T redmine bundle exec rake redmine_recurring_tasks:exec RAILS_ENV=production >> /opt/tg_bot/cron_debug.log 2>&1

echo "Exit code: $?" >> /opt/tg_bot/cron_debug.log



################################################################################
üìÑ FILE: ./storage/redmine/configuration.yml
################################################################################
# = Redmine configuration file
#
# Each environment has its own configuration options.  If you are only
# running in production, only the production block needs to be configured.
# Environment specific configuration options override the default ones.
#
# Note that this file needs to be a valid YAML file.
# DO NOT USE TABS! Use 2 spaces instead of tabs for indentation.

# default configuration options for all environments
default:
  # Outgoing emails configuration
  # See the examples below and the Rails guide for more configuration options:
  # http://guides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration
  email_delivery:
    delivery_method: :smtp
    smtp_settings:
      ssl: true
      address: email.gpnof.ru
      port: 465
      authentication: :login
      domain: gpnof.ru
      user_name: help
      password: xYk!4!!V-7
      enable_starttls_auto: true
      openssl_verify_mode: none

  # ==== Simple SMTP server at localhost
  #
  #  email_delivery:
  #    delivery_method: :smtp
  #    smtp_settings:
  #      address: "localhost"
  #      port: 25
  #
  # ==== SMTP server at example.com using LOGIN authentication and checking HELO for foo.com
  #
  #  email_delivery:
  #    delivery_method: :smtp
  #    smtp_settings:
  #      address: "example.com"
  #      port: 25
  #      authentication: :login
  #      domain: 'foo.com'
  #      user_name: 'myaccount'
  #      password: 'password'
  #
  # ==== SMTP server at example.com using PLAIN authentication
  #
  #  email_delivery:
  #    delivery_method: :smtp
  #    smtp_settings:
  #      address: "example.com"
  #      port: 25
  #      authentication: :plain
  #      domain: 'example.com'
  #      user_name: 'myaccount'
  #      password: 'password'
  #
  # ==== SMTP server at using TLS (GMail)
  # This might require some additional configuration. See the guides at:
  # http://www.redmine.org/projects/redmine/wiki/EmailConfiguration
  #
  #  email_delivery:
  #    delivery_method: :smtp
  #    smtp_settings:
  #      enable_starttls_auto: true
  #      address: "smtp.gmail.com"
  #      port: 587
  #      domain: "smtp.gmail.com" # 'your.domain.com' for GoogleApps
  #      authentication: :plain
  #      user_name: "your_email@gmail.com"
  #      password: "your_password"
  #
  # ==== Sendmail command
  #
  #  email_delivery:
  #    delivery_method: :sendmail

  # Absolute path to the directory where attachments are stored.
  # The default is the 'files' directory in your Redmine instance.
  # Your Redmine instance needs to have write permission on this
  # directory.
  # Examples:
  # attachments_storage_path: /var/redmine/files
  # attachments_storage_path: D:/redmine/files
  attachments_storage_path: /usr/src/redmine/files

  # Configuration of the autologin cookie.
  # autologin_cookie_name: the name of the cookie (default: autologin)
  # autologin_cookie_path: the cookie path (default: /)
  # autologin_cookie_secure: true sets the cookie secure flag (default: false)
  autologin_cookie_name:
  autologin_cookie_path:
  autologin_cookie_secure:

  # Configuration of SCM executable command.
  #
  # Absolute path (e.g. /usr/local/bin/hg) or command name (e.g. hg.exe, bzr.exe)
  # On Windows + CRuby, *.cmd, *.bat (e.g. hg.cmd, bzr.bat) does not work.
  #
  # On Windows + JRuby 1.6.2, path which contains spaces does not work.
  # For example, "C:\Program Files\TortoiseHg\hg.exe".
  # If you want to this feature, you need to install to the path which does not contains spaces.
  # For example, "C:\TortoiseHg\hg.exe".
  #
  # Examples:
  # scm_subversion_command: svn                                       # (default: svn)
  # scm_mercurial_command:  C:\Program Files\TortoiseHg\hg.exe        # (default: hg)
  # scm_git_command:        /usr/local/bin/git                        # (default: git)
  # scm_cvs_command:        cvs                                       # (default: cvs)
  # scm_bazaar_command:     bzr.exe                                   # (default: bzr)
  #
  scm_subversion_command:
  scm_mercurial_command:
  scm_git_command:
  scm_cvs_command:
  scm_bazaar_command:

  # SCM paths validation.
  #
  # You can configure a regular expression for each SCM that will be used to
  # validate the path of new repositories (eg. path entered by users with the
  # "Manage repositories" permission and path returned by reposman.rb).
  # The regexp will be wrapped with \A \z, so it must match the whole path.
  # And the regexp is case sensitive.
  #
  # You can match the project identifier by using %project% in the regexp.
  #
  # You can also set a custom hint message for each SCM that will be displayed
  # on the repository form instead of the default one.
  #
  # Examples:
  # scm_subversion_path_regexp: file:///svnpath/[a-z0-9_]+
  # scm_subversion_path_info: SVN URL (eg. file:///svnpath/foo)
  #
  # scm_git_path_regexp: /gitpath/%project%(\.[a-z0-9_])?/
  #
  scm_subversion_path_regexp:
  scm_mercurial_path_regexp:
  scm_git_path_regexp:
  scm_cvs_path_regexp:
  scm_bazaar_path_regexp:
  scm_filesystem_path_regexp:

  # Absolute path to the SCM commands errors (stderr) log file.
  # The default is to log in the 'log' directory of your Redmine instance.
  # Example:
  # scm_stderr_log_file: /var/log/redmine_scm_stderr.log
  scm_stderr_log_file:

  # Key used to encrypt sensitive data in the database (SCM passwords,
  # LDAP passwords, and TOTP (two-factor authentication) secret keys).
  # If you don't want to enable data encryption, just leave it blank.
  # WARNING: losing/changing this key will make encrypted data unreadable.
  #
  # If you want to encrypt existing data in your database:
  # * set the cipher key here in your configuration file
  # * encrypt data using 'rake db:encrypt RAILS_ENV=production'
  #
  # If you have encrypted data and want to change this key, you have to:
  # * decrypt data using 'rake db:decrypt RAILS_ENV=production' first
  # * change the cipher key here in your configuration file
  # * encrypt data using 'rake db:encrypt RAILS_ENV=production'
  database_cipher_key:

  # Your secret key for verifying cookie session data integrity. If you
  # change this key, all old sessions will become invalid! Make sure the
  # secret is at least 30 characters and all random, no regular words or
  # you'll be exposed to dictionary attacks.
  #
  # If you have a load-balancing Redmine cluster, you have to use the
  # same secret token on each machine.
  #secret_token: 'change it to a long random string'

  # Requires users to re-enter their password for sensitive actions (editing
  # of account data, project memberships, application settings, user, group,
  # role, auth source management and project deletion). Disabled by default.
  # Timeout is set in minutes.
  #
  #sudo_mode: true
  #sudo_mode_timeout: 15

  # Absolute path (e.g. /usr/bin/convert, c:/im/convert.exe) to
  # the ImageMagick's `convert` binary. Used to generate attachment thumbnails.
  #imagemagick_convert_command:

  # Absolute path (e.g. /usr/bin/gs, c:/ghostscript/gswin64c.exe) to
  # the `gs` binary. Used to generate attachment thumbnails of PDF files.
  #gs_command:

  # Timeout when generating thumbnails using the `convert` or `gs` command.
  # Timeout is set in seconds.
  #thumbnails_generation_timeout: 10

  # Configuration of MiniMagick font.
  #
  # Redmine uses MiniMagick in order to export a gantt chart to a PNG image.
  # This setting is necessary to properly display CJK (Chinese, Japanese,
  # and Korean) characters in the PNG image. Please make sure that the
  # specified font is installed in the Redmine server.
  #
  # This setting is necessary only when CJK characters are used in gantt.
  #
  # Note that rmagick_font_path in prior to Redmine 4.1.0 has been renamed
  # to minimagick_font_path.
  #
  # Examples for Japanese:
  #   Windows:
  #     minimagick_font_path: C:\windows\fonts\msgothic.ttc
  #   Linux:
  #     minimagick_font_path: /usr/share/fonts/ipa-mincho/ipam.ttf
  #
  minimagick_font_path:

  # Maximum number of simultaneous AJAX uploads
  #max_concurrent_ajax_uploads: 2

  # URL of the avatar server
  #
  # By default, Redmine uses Gravatar as the avatar server for displaying
  # user icons. You can switch to another Gravatar-compatible server such
  # as Libravatar and opensource servers listed on
  # https://wiki.libravatar.org/running_your_own/
  #
  # URL of each avatar is: #{avatar_server_url}/avatar/#{hash}
  #
  #avatar_server_url: https://www.gravatar.com        # default
  #avatar_server_url: https://seccdn.libravatar.org

  # Configure CommonMark hardbreaks behaviour
  #
  # allowed values: true, false
  # true: treats regular line break (\n) as hardbreaks
  # false: switches to default common mark where two or more spaces are required
  # common_mark_enable_hardbreaks: true

# specific configuration options for production environment
# that overrides the default ones
production:

# specific configuration options for development environment
# that overrides the default ones
development:



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/controllers/email_reports_controller.rb
################################################################################
class EmailReportsController < ApplicationController
  layout 'admin'
  before_action :require_admin
  before_action :find_email_report, only: [:show, :edit, :update, :destroy, :test, :toggle_active]

  def index
    @email_reports = EmailReport.includes(:author, :recipients).order(:name)
  end

  def show
    @data = @email_report.generate_report_data
  end

  def new
    @email_report = EmailReport.new(
      author: User.current,
      send_time: Time.parse('08:00'),
      schedule_type: 'weekly',
      report_type: 'issues',
      query_filters: { "status_id" => { "operator" => "o", "values" => [""] } },
      columns: %w[id subject status assigned_to updated_on],
      report_period_days: 7
    )
  end

  def create
    @email_report = EmailReport.new(email_report_params)
    @email_report.author = User.current

    if @email_report.save
      update_recipients
      flash[:notice] = l(:notice_successful_create)
      redirect_to email_reports_path
    else
      render :new
    end
  end

  def edit
  end

  def update
    if @email_report.update(email_report_params)
      update_recipients
      flash[:notice] = l(:notice_successful_update)
      redirect_to email_reports_path
    else
      render :edit
    end
  end

  def destroy
    @email_report.destroy
    flash[:notice] = l(:notice_successful_delete)
    redirect_to email_reports_path
  end

  def test
    EmailReportJob.perform_now(@email_report.id)
    flash[:notice] = l(:notice_email_report_test_sent)
  rescue => e
    flash[:error] = "#{l(:notice_email_report_test_failed)}: #{e.message}"
  ensure
    redirect_to email_reports_path
  end

  def toggle_active
    @email_report.update(is_active: !@email_report.is_active)
    flash[:notice] = @email_report.is_active ? l(:notice_email_report_activated) : l(:notice_email_report_deactivated)
    redirect_to email_reports_path
  end

  def available_principals
    scope = Principal.active.like(params[:q]).limit(20)
    scope = scope.where(type: params[:type]) if params[:type].present?
    
    principals = scope.map do |p|
      extra_info = ""
      if p.is_a?(User)
        groups = p.groups.map(&:lastname).join(', ')
        extra_info = groups.present? ? "(#{groups})" : ""
      end

      {
        id: p.id,
        name: p.name,
        type: p.type,
        extra: extra_info,
        icon: p.is_a?(User) ? 'icon-user' : 'icon-group'
      }
    end
    
    render json: principals
  rescue => e
    render json: { error: e.message }, status: 500
  end

  private

  def find_email_report
    @email_report = EmailReport.find(params[:id])
  rescue ActiveRecord::RecordNotFound
    render_404
  end

  def email_report_params
    # 1. –†–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã + week_days –º–∞—Å—Å–∏–≤ + time_hour + time_min
    p = params.require(:email_report).permit(
      :name, :description, :schedule_type, :schedule_cron, 
      :project_id, :report_type, :group_by, :is_active, 
      :source_group_id, :report_period_days, 
      { query_filters: {} }, { columns: [] }, { week_days: [] },
      :time_hour, :time_min
    )

    # 2. –°–ë–û–†–ö–ê –í–†–ï–ú–ï–ù–ò –ò–ó –°–ï–õ–ï–ö–¢–û–í
    if params[:email_report][:time_hour].present? && params[:email_report][:time_min].present?
      # –°–∫–ª–µ–∏–≤–∞–µ–º "08" –∏ "30" –≤ "08:30"
      p[:send_time] = "#{params[:email_report][:time_hour]}:#{params[:email_report][:time_min]}"
    end

    # 3. –õ–û–ì–ò–ö–ê –î–ù–ï–ô –ù–ï–î–ï–õ–ò (Weekly)
    if p[:schedule_type] == 'weekly'
      if params[:email_report][:week_days].present?
        # –°–∫–ª–µ–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ ["1", "5"] –≤ —Å—Ç—Ä–æ–∫—É "1,5"
        p[:schedule_cron] = params[:email_report][:week_days].join(',')
      else
        # –î–µ—Ñ–æ–ª—Ç, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
        p[:schedule_cron] = '1' 
      end
    end

    # 4. –û—á–∏—Å—Ç–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –≤ –º–æ–¥–µ–ª—å
    # –£–¥–∞–ª—è–µ–º week_days, time_hour, time_min - –æ–Ω–∏ –Ω–µ –Ω—É–∂–Ω—ã –≤ update(attributes)
    p.except(:week_days, :time_hour, :time_min)
  end

  def update_recipients
    incoming_recipients = []
    
    # UI (User/Group)
    if params[:recipients_data].present?
      params[:recipients_data].each do |_, data|
        next if data[:id].blank? || data[:type].blank?
        
        type = data[:type] == 'User' ? 'user' : 'group'
        incoming_recipients << { type: type, id: data[:id].to_i, email: nil }
      end
    end
    
    # Textarea Emails
    if params[:recipient_emails].present?
      params[:recipient_emails].split("\n").map(&:strip).reject(&:blank?).each do |email|
        incoming_recipients << { type: 'email', id: nil, email: email }
      end
    end

    # –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö
    @email_report.recipients.each do |existing|
      found = incoming_recipients.find do |inc|
        if existing.recipient_type == 'email'
          inc[:type] == 'email' && inc[:email] == existing.email
        else
          inc[:type] == existing.recipient_type && inc[:id] == existing.recipient_id
        end
      end
      
      existing.destroy unless found
    end

    # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö
    incoming_recipients.each do |inc|
      exists = @email_report.recipients.exists?(
        recipient_type: inc[:type],
        recipient_id: inc[:id],
        email: inc[:email]
      )
      
      unless exists
        @email_report.recipients.create!(
          recipient_type: inc[:type],
          recipient_id: inc[:id],
          email: inc[:email]
        )
      end
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/jobs/email_report_job.rb
################################################################################
class EmailReportJob < ApplicationJob
  queue_as :default

  def perform(report_id)
    report = EmailReport.find_by(id: report_id)
    return unless report
    
    data = report.generate_report_data
    
    report.recipient_users.each do |user|
      begin
        ReportMailer.report_email(report, user, data).deliver_now
      rescue => e
        Rails.logger.error "Failed to send report #{report.id} to #{user.mail}: #{e.message}"
      end
    end
    
    report.update_column(:last_sent_at, Time.current)
  rescue => e
    Rails.logger.error "Failed to process email report #{report_id}: #{e.message}"
    raise e
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/mailers/report_mailer.rb
################################################################################
class ReportMailer < ActionMailer::Base
  helper :application
  default from: Setting.mail_from
  
  def report_email(report, user, data)
    @report = report
    @user = user
    @data = data
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ host –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫
    host = Setting.host_name
    protocol = Setting.protocol
    default_url_options[:host] = host
    default_url_options[:protocol] = protocol
    
    # –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
    Rails.logger.info "üìß –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞ #{report.name} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é #{user.mail}"
    
    subject = "[#{Setting.app_title}] #{report.name}"
    
    mail(to: user.mail, subject: subject) do |format|
      format.html { render layout: 'mailer' }
    end
    
    # –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
    Rails.logger.info "‚úÖ –û—Ç—á—ë—Ç #{report.name} —É—Å–ø–µ—à–Ω–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è #{user.mail}"
  rescue => e
    Rails.logger.error "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç—á—ë—Ç–∞ #{report.name} –¥–ª—è #{user.mail}: #{e.message}"
    raise e
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/models/email_report_job.rb
################################################################################
# app/jobs/email_report_job.rb
class EmailReportJob < ActiveJob::Base
  queue_as :default

  def perform(email_report_id)
    email_report = EmailReport.find(email_report_id)
    return unless email_report.ready_to_send?

    begin
      data = email_report.generate_report_data
      recipients = email_report.recipient_users

      recipients.each do |user|
        ReportMailer.report_email(email_report, user, data).deliver_later
      end

      email_report.update(last_sent_at: Time.current)
    rescue => e
      Rails.logger.error "Failed to send EmailReport##{email_report_id}: #{e.message}"
      Rails.logger.error e.backtrace.join("\n")
      raise # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º job –ø—Ä–∏ –æ—à–∏–±–∫–µ
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/models/email_report.rb
################################################################################
class EmailReport < ActiveRecord::Base
  belongs_to :author, class_name: 'User'
  belongs_to :project
  belongs_to :source_group, class_name: 'Group', foreign_key: 'source_group_id', optional: true
  belongs_to :recipient_group, class_name: 'Group', foreign_key: 'recipient_group_id', optional: true
  has_many :recipients, class_name: 'EmailReportRecipient', dependent: :destroy

  validates :name, presence: true, length: { maximum: 255 }
  validates :schedule_type, inclusion: { in: %w[daily weekly monthly custom] }
  validates :report_type, inclusion: { in: %w[issues time_entries] }
  validates :send_time, presence: true

  scope :active, -> { where(is_active: true) }
  scope :ready_to_send, -> { where("last_sent_at IS NULL OR (CASE schedule_type 
                 WHEN 'daily'    THEN last_sent_at < ?
                 WHEN 'weekly'   THEN last_sent_at < ? 
                 WHEN 'monthly'  THEN last_sent_at < ?
               END)", 1.day.ago, 1.week.ago, 1.month.ago) }

  def ready_to_send?
    return false unless is_active
    return true if last_sent_at.nil?

    case schedule_type
    when 'daily'   then last_sent_at < 1.day.ago
    when 'weekly'  then last_sent_at < 1.week.ago
    when 'monthly' then last_sent_at < 1.month.ago
    else false
    end
  end

  def recipient_users
    users = Set.new

    recipients.each do |recipient|
      case recipient.recipient_type
      when 'user'
        user = User.find_by(id: recipient.recipient_id)
        users << user if user && user.active?
      when 'group'
        group = Group.find_by(id: recipient.recipient_id)
        users.merge(group.users.active) if group
      when 'role'
        role = Role.find_by(id: recipient.recipient_id)
        if role && project
          users.merge(project.principals_by_role[role]&.select(&:active?) || [])
        end
      when 'email'
        user = User.new(mail: recipient.email, firstname: 'External', lastname: 'User')
        users << user
      end
    end

    users.compact
  end

  # SQL Queries
  SQL_QUERIES = {
    group_users: <<-SQL,
      SELECT u.id, u.firstname, u.lastname
      FROM users u
      JOIN groups_users gu ON gu.user_id = u.id
      WHERE gu.group_id = $1
      ORDER BY u.lastname, u.firstname
    SQL
    
    group_emails: <<-SQL,
      SELECT DISTINCT ea.address
      FROM users u
      JOIN groups_users gu ON gu.user_id = u.id
      JOIN email_addresses ea ON ea.user_id = u.id
      WHERE gu.group_id = $1
        AND u.status = 1
        AND ea.is_default = true
    SQL
    
    closed_issues_by_user: <<-SQL,
      SELECT 
        closer.id as user_id,
        closer.firstname,
        closer.lastname,
        COUNT(DISTINCT i.id) as closed_count
      FROM issues i
      JOIN journals j ON j.journalized_id = i.id AND j.journalized_type = 'Issue'
      JOIN journal_details jd ON jd.journal_id = j.id
      JOIN users closer ON closer.id = j.user_id
      JOIN groups_users gu ON gu.user_id = closer.id
      WHERE j.created_on BETWEEN $1 AND $2
        AND jd.prop_key = 'status_id'
        AND jd.value IN (SELECT CAST(id AS text) FROM issue_statuses WHERE is_closed = true)
        AND gu.group_id = $3
      GROUP BY closer.id, closer.firstname, closer.lastname
      ORDER BY closed_count DESC, closer.lastname, closer.firstname
    SQL
    
    user_closed_issues_detail: <<-SQL,
      SELECT DISTINCT
        i.id as issue_id,
        i.subject,
        i.created_on,
        i.closed_on,
        s.name as status_name,
        j.created_on as closed_date
      FROM issues i
      JOIN issue_statuses s ON s.id = i.status_id
      JOIN journals j ON j.journalized_id = i.id AND j.journalized_type = 'Issue'
      JOIN journal_details jd ON jd.journal_id = j.id
      JOIN users closer ON closer.id = j.user_id
      JOIN groups_users gu ON gu.user_id = closer.id
      WHERE j.created_on BETWEEN $1 AND $2
        AND jd.prop_key = 'status_id'
        AND jd.value IN (SELECT CAST(id AS text) FROM issue_statuses WHERE is_closed = true)
        AND gu.group_id = $3
        AND closer.id = $4
      ORDER BY j.created_on DESC
    SQL
    
    assigned_open_issues: <<-SQL,
      SELECT 
        i.id,
        i.subject,
        i.created_on,
        s.name as status_name,
        i.assigned_to_id,
        assignee.firstname as assignee_firstname,
        assignee.lastname as assignee_lastname,
        u.firstname as author_firstname,
        u.lastname as author_lastname
      FROM issues i
      JOIN issue_statuses s ON s.id = i.status_id
      JOIN users u ON u.id = i.author_id
      JOIN users assignee ON assignee.id = i.assigned_to_id
      JOIN groups_users gu ON gu.user_id = assignee.id
      WHERE s.is_closed = false
        AND i.assigned_to_id IS NOT NULL
        AND gu.group_id = $1
      ORDER BY assignee.lastname, assignee.firstname, i.updated_on DESC
    SQL
    
    unassigned_open_issues: <<-SQL,
      SELECT 
        i.id,
        i.subject,
        i.created_on,
        s.name as status_name,
        u.firstname as author_firstname,
        u.lastname as author_lastname
      FROM issues i
      JOIN issue_statuses s ON s.id = i.status_id
      JOIN users u ON u.id = i.author_id
      WHERE s.is_closed = false
        AND i.assigned_to_id IS NULL
      ORDER BY i.updated_on DESC
    SQL
    
    total_issues_closed: <<-SQL
      SELECT COUNT(DISTINCT i.id) as total_count
      FROM issues i
      JOIN journals j ON j.journalized_id = i.id AND j.journalized_type = 'Issue'
      JOIN journal_details jd ON jd.journal_id = j.id
      JOIN users closer ON closer.id = j.user_id
      JOIN groups_users gu ON gu.user_id = closer.id
      WHERE j.created_on BETWEEN $1 AND $2
        AND jd.prop_key = 'status_id'
        AND jd.value IN (SELECT CAST(id AS text) FROM issue_statuses WHERE is_closed = true)
        AND gu.group_id = $3
    SQL
  }

  def generate_report_data
    case report_type
    when 'issues'        then generate_issues_report_with_group_logic
    when 'time_entries'  then generate_time_entries_report
    else raise "Unknown report type: #{report_type}"
    end
  end

  private

  def generate_issues_report_with_group_logic
    source_group_id = source_group_id_for_query
    
    unless source_group_id
      Rails.logger.warn "EmailReport ##{id}: No source_group_id found. Falling back to standard report."
      return generate_issues_report 
    end
    
    conn = PG.connect(db_config)
    
    end_date = Date.today
    period = report_period_days || 7
    start_date = end_date - period
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ —Å—Ç—Ä–æ–∫–∏/—á–∏—Å–ª–∞ –¥–ª—è PG exec_params
    start_date_s = start_date.to_s
    end_date_s = end_date.to_s
    group_id_i = source_group_id.to_i
    
    group_users = conn.exec_params(SQL_QUERIES[:group_users], [group_id_i]).to_a
    user_names = group_users.map { |u| [u['id'].to_i, "#{u['firstname']} #{u['lastname']}"] }.to_h
    
    closed_issues_count = conn.exec_params(
      SQL_QUERIES[:total_issues_closed], 
      [start_date_s, end_date_s, group_id_i]
    )[0]['total_count'].to_i
    
    closed_issues_by_user = conn.exec_params(
      SQL_QUERIES[:closed_issues_by_user], 
      [start_date_s, end_date_s, group_id_i]
    ).to_a
    
    assigned_open_issues = conn.exec_params(
      SQL_QUERIES[:assigned_open_issues], 
      [group_id_i]
    ).to_a
    
    unassigned_open_issues = conn.exec_params(SQL_QUERIES[:unassigned_open_issues]).to_a
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏
    closed_issues_by_user.each do |user|
      user_id = user['user_id'].to_i
      user_closed_issues = conn.exec_params(
        SQL_QUERIES[:user_closed_issues_detail],
        [start_date_s, end_date_s, group_id_i, user_id]
      ).to_a
      user['_closed_issues_details'] = user_closed_issues
    end
    
    conn.close
    
    {
      start_date: start_date,
      end_date: end_date,
      source_group: Group.find_by(id: group_id_i),
      group_users: group_users,
      user_names: user_names,
      closed_issues_count: closed_issues_count,
      closed_issues_by_user: closed_issues_by_user,
      assigned_open_issues: assigned_open_issues,
      unassigned_open_issues: unassigned_open_issues,
      issues: generate_issues_from_data(assigned_open_issues + unassigned_open_issues),
      query: nil,
      total_count: closed_issues_count + assigned_open_issues.count + unassigned_open_issues.count
    }
  rescue => e
    Rails.logger.error "–û—à–∏–±–∫–∞ –≤ generate_issues_report_with_group_logic: #{e.message}"
    Rails.logger.error e.backtrace.join("\n")
    raise e
  end

  def generate_issues_from_data(issues_data)
    return [] unless issues_data.is_a?(Array)
    issue_ids = issues_data.map { |i| i['id'] }.compact
    Issue.where(id: issue_ids).limit(1000)
  end

  def source_group_id_for_query
    return source_group.id if source_group
    return self[:source_group_id] if self[:source_group_id].present?
    nil
  end

  def db_config
    {
      host: ENV['DATABASE_HOST'] || 'postgres',
      port: 5432,
      dbname: ENV['DATABASE_NAME'] || 'redmine',
      user: ENV['DATABASE_USER'] || 'postgres',
      password: ENV['DATABASE_PASSWORD'] || 'PASSWORD'
    }
  end

  def generate_issues_report
    query = IssueQuery.new(name: name, project: project, user: author)
    query.filters = query_filters.deep_stringify_keys
    query.column_names = columns if columns.any?
    query.group_by = group_by if group_by.present?

    issues = query.issues(limit: 1000)
    {
      issues:      issues,
      query:       query,
      total_count: query.issue_count
    }
  end

  def generate_time_entries_report
    scope = TimeEntry.where(project: project).includes(:issue, :user, :activity)
    # ... standard filters ...
    {
      time_entries: scope.limit(1000),
      total_hours:  scope.sum(:hours)
    }
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/models/email_report_recipient.rb
################################################################################
class EmailReportRecipient < ActiveRecord::Base
  belongs_to :email_report

  validates :recipient_type, inclusion: { in: %w[user group role email] }
  validates :recipient_id, presence: true, if: -> { !email? }
  validates :email, presence: true, if: -> { email? }

  def email?
    recipient_type == 'email'
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/models/report_mailer.rb
################################################################################
# plugins/email_reports/app/models/report_mailer.rb
class ReportMailer < Mailer  # –ë—ã–ª–æ: ApplicationMailer
  def report_email(email_report, user, data)
    @email_report = email_report
    @user = user
    @data = data

    mail(to: user.mail,
         from: Setting.mail_from,
         subject: "#{email_report.name} - #{format_date(Time.current)}") do |format|
      format.html { render layout: 'mailer' }
      format.text
    end
  end

  private

  def format_date(date)
    I18n.l(date, format: :long)
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/email_reports/edit.html.erb
################################################################################
<h2><%= l(:label_email_report_edit) %></h2>

<%= error_messages_for @email_report %>

<%= form_for @email_report, url: { action: 'update', id: @email_report } do |f| %>
  <%= render 'form', f: f %>
<% end %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/email_reports/_filter_row.html.erb
################################################################################
<tr class="filter-row">
  <td>
    <%= select_tag "email_report[query_filters][#{index}][field]",
        options_for_select(available_filters.keys, field),
        { include_blank: true, class: 'filter-field', data: { index: index } } %>
  </td>
  <td>
    <%= select_tag "email_report[query_filters][#{index}][operator]",
        options_for_select(Query.operators.keys, filter['operator'] || '='),
        { class: 'filter-operator' } %>
  </td>
  <td>
    <%= text_field_tag "email_report[query_filters][#{index}][values][]",
        filter['values']&.first,
        { class: 'filter-values', placeholder: '–∑–Ω–∞—á–µ–Ω–∏–µ' } %>
  </td>
  <td>
    <%= link_to '√ó', '#', 
        class: 'icon icon-del', 
        onclick: 'removeFilter(this); return false;' %>
  </td>
</tr>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/email_reports/_form.html.erb
################################################################################
<%= form_for @email_report, html: { class: 'form' } do |f| %>
  <%= error_messages_for @email_report %>

  <div class="splitcontent">
    <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="splitcontentleft">
      <fieldset class="box tabular">
        <legend><%= l(:label_general) %></legend>
        
        <p>
          <%= f.label :name, l(:field_name), class: 'required' %>
          <%= f.text_field :name, required: true, style: 'width: 95%;' %>
        </p>

        <p>
          <%= f.label :description, l(:field_description) %>
          <%= f.text_area :description, rows: 3, style: 'width: 95%;' %>
        </p>

        <p>
          <%= f.label :project_id, l(:field_project) %>
          <%= f.select :project_id, 
              options_from_collection_for_select(Project.active.order(:name), :id, :name, @email_report.project_id),
              { include_blank: true }, { style: 'width: 95%;' } %>
        </p>

        <p>
          <%= f.label :is_active, l(:field_is_active) %>
          <%= f.check_box :is_active %>
        </p>
      </fieldset>

      <fieldset class="box tabular">
        <legend><%= l(:label_email_report_type) %></legend>
        
        <p>
          <%= f.label :report_type, "–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö" %>
          <%= f.select :report_type, 
              options_for_select([
                [l(:label_email_report_type_issues), 'issues'],
                [l(:label_email_report_type_time_entries), 'time_entries']
              ], @email_report.report_type), {}, { data: { toggle_report_type: true }, style: 'width: 95%;' } %>
        </p>

        <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∑–∞–¥–∞—á -->
        <div id="issues_specific_fields">
          <p>
            <%= f.label :source_group_id, "–ò—Å—Ç–æ—á–Ω–∏–∫ (–ì—Ä—É–ø–ø–∞)" %>
            <%= f.select :source_group_id, 
                options_from_collection_for_select(Group.sorted, :id, :lastname, @email_report.source_group_id),
                { include_blank: "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏" },
                { style: 'width: 95%;' } %>
            <br><em class="info" style="margin-left: 180px;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—Å–µ–º</em>
          </p>
          
          <p>
            <%= f.label :report_period_days, "–ó–∞ –ø–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)" %>
            <%= f.number_field :report_period_days, value: @email_report.report_period_days || 7, min: 1, max: 365, style: 'width: 60px;' %>
          </p>

          <p>
            <%= f.label :group_by, l(:label_email_report_group_by) %>
            <%= f.select :group_by, 
                options_for_select([
                  [l(:field_status), 'status'],
                  [l(:field_priority), 'priority'],
                  [l(:field_assigned_to), 'assigned_to']
                ], @email_report.group_by),
                { include_blank: true }, { style: 'width: 95%;' } %>
          </p>
        </div>
      </fieldset>
    </div>

    <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ -->
    <div class="splitcontentright">
      <fieldset class="box tabular">
        <legend>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</legend>

        <p>
          <%= f.label :schedule_type, l(:label_email_report_schedule_type) %>
          <%= f.select :schedule_type, 
              options_for_select([
                [l(:label_email_report_schedule_daily), 'daily'],
                [l(:label_email_report_schedule_weekly), 'weekly'],
                [l(:label_email_report_schedule_monthly), 'monthly'],
                [l(:label_email_report_schedule_custom), 'custom']
              ], @email_report.schedule_type), 
              {}, 
              onchange: "toggleScheduleFields(this.value);",
              style: 'width: 95%;' %>
        </p>

        <!-- –í—ã–±–æ—Ä –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ -->
        <p id="weekly_days_container" style="display:none;">
          <label>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
          <span style="display: block; margin-left: 0; padding-top: 5px;">
            <% 
              current_val = @email_report.schedule_cron.to_s
              is_cron = current_val.include?('*') || current_val.include?(' ')
              current_days = is_cron ? [] : current_val.split(',').map(&:to_i)
              days_map = { 1 => '–ü–Ω', 2 => '–í—Ç', 3 => '–°—Ä', 4 => '–ß—Ç', 5 => '–ü—Ç', 6 => '–°–±', 0 => '–í—Å' }
            %>
            <% days_map.each do |idx, name| %>
              <label style="display: inline-block; margin-right: 10px; margin-left: 0; width: auto; float: none;">
                <%= check_box_tag "email_report[week_days][]", idx, current_days.include?(idx) %> <%= name %>
              </label>
            <% end %>
          </span>
        </p>

        <!-- Cron -->
        <p id="cron_field" style="display:none;">
          <%= f.label :schedule_cron, "Cron –≤—ã—Ä–∞–∂–µ–Ω–∏–µ" %>
          <%= f.text_field :schedule_cron, placeholder: '0 8 * * *', style: 'width: 95%;' %>
          <br><em class="info" style="margin-left: 180px;">–§–æ—Ä–º–∞—Ç: –º–∏–Ω —á–∞—Å –¥–µ–Ω—å –º–µ—Å –¥–µ–Ω—å_–Ω–µ–¥–µ–ª–∏</em>
        </p>

        <!-- –í–†–ï–ú–Ø –û–¢–ü–†–ê–í–ö–ò (–î–í–ê –°–ï–õ–ï–ö–¢–ê) -->
        <p>
          <label><%= l(:label_email_report_send_time) %></label>
          <% 
             # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç 08:00
             time_val = @email_report.send_time || Time.parse("08:00")
             selected_hour = time_val.strftime("%H")
             selected_min = time_val.strftime("%M")
             # –û–∫—Ä—É–≥–ª–∏–º –º–∏–Ω—É—Ç—ã –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö 5, —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –≤—Å—Ç–∞–ª–æ –≤ —Å–µ–ª–µ–∫—Ç, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –≤ –±–∞–∑–µ 03 –º–∏–Ω—É—Ç—ã
             selected_min_i = selected_min.to_i
             rounded_min = (selected_min_i / 5.0).round * 5
             rounded_min = 0 if rounded_min == 60
             selected_min_str = rounded_min.to_s.rjust(2, '0')
          %>
          
          <%= select_tag "email_report[time_hour]", 
              options_for_select((0..23).map { |h| [h.to_s.rjust(2, '0'), h.to_s.rjust(2, '0')] }, selected_hour),
              id: "email_report_time_hour",
              style: "width: auto; display: inline-block;" 
          %>
          :
          <%= select_tag "email_report[time_min]", 
              options_for_select((0..55).step(5).map { |m| [m.to_s.rjust(2, '0'), m.to_s.rjust(2, '0')] }, selected_min_str),
              id: "email_report_time_min",
              style: "width: auto; display: inline-block;" 
          %>
          <span style="color: #777; font-size: 0.9em; margin-left: 5px;">(MSK)</span>
        </p>
      </fieldset>
    </div>
  </div>

  <!-- –ü–û–õ–£–ß–ê–¢–ï–õ–ò -->
  <fieldset class="box">
    <legend><%= l(:label_email_report_recipients) %></legend>
    
    <div style="background: #fcfcfc; padding: 10px; border: 1px solid #e4e4e4; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
      <label style="font-weight: bold;">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
      <%= text_field_tag 'recipient_search', '', id: 'recipient_search', placeholder: '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—ã...', style: 'width: 350px; padding: 4px;' %>
      <%= button_tag '–î–æ–±–∞–≤–∏—Ç—å', type: 'button', id: 'add_recipient_btn', class: 'icon icon-add', disabled: true %>
    </div>

    <div id="recipients_list">
      <table class="list" style="width: 100%">
        <thead>
          <tr>
            <th style="text-align: left; padding-left: 10px;">–ò–º—è / –ì—Ä—É–ø–ø–∞</th>
            <th style="width: 150px;">–¢–∏–ø</th>
            <th style="width: 100px; text-align: center;">–£–¥–∞–ª–∏—Ç—å</th>
          </tr>
        </thead>
        <tbody id="recipients_tbody">
          <% @email_report.recipients.each_with_index do |recipient, index| %>
            <% next if recipient.recipient_type == 'email' %>
            <% 
               principal = case recipient.recipient_type
                           when 'user' then User.find_by(id: recipient.recipient_id)
                           when 'group' then Group.find_by(id: recipient.recipient_id)
                           end
               next unless principal
               name = principal.is_a?(User) ? principal.name : principal.lastname
               type_label = recipient.recipient_type == 'user' ? 'User' : 'Group'
               display_type = if recipient.recipient_type == 'user'
                                groups = principal.groups.map(&:lastname).join(', ')
                                "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #{groups.present? ? "(#{groups})" : ''}"
                              else
                                "–ì—Ä—É–ø–ø–∞"
                              end
            %>
            <tr class="recipient-row">
              <td style="padding-left: 10px;">
                <span class="<%= recipient.recipient_type == 'user' ? 'icon icon-user' : 'icon-group' %>">
                  <%= name %>
                </span>
                <input type="hidden" name="recipients_data[<%= index %>][id]" value="<%= recipient.recipient_id %>">
                <input type="hidden" name="recipients_data[<%= index %>][type]" value="<%= type_label %>">
              </td>
              <td><%= display_type %></td>
              <td style="text-align: center;">
                <a href="#" class="icon icon-del" onclick="removeRow(this); return false;"></a>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px dashed #ccc;">
      <p>
        <label style="font-weight: bold; display: block; margin-bottom: 5px;">–í–Ω–µ—à–Ω–∏–µ Email –∞–¥—Ä–µ—Å–∞ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
        <%= text_area_tag 'recipient_emails', 
            @email_report.recipients.where(recipient_type: 'email').pluck(:email).join("\n"),
            rows: 3, style: 'width: 100%; max-width: 600px; font-family: monospace;' %>
      </p>
    </div>
  </fieldset>

  <div style="margin-top: 15px;">
    <%= f.submit l(:button_save) %>
  </div>
<% end %>

<style>
  .splitcontentleft fieldset, .splitcontentright fieldset {
    min-height: 280px; 
  }
  fieldset.tabular p {
    margin-bottom: 10px;
  }
</style>

<script>
function toggleScheduleFields(val) {
  if (val === 'custom') {
    $('#cron_field').show();
  } else {
    $('#cron_field').hide();
  }
  if (val === 'weekly') {
    $('#weekly_days_container').show();
  } else {
    $('#weekly_days_container').hide();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  const scheduleSelect = document.getElementById('email_report_schedule_type');
  if (scheduleSelect) toggleScheduleFields(scheduleSelect.value);

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞
  const reportTypeSelect = document.querySelector('[data-toggle-report-type]');
  const issuesSpecificFields = document.getElementById('issues_specific_fields');
  
  function toggleFields() {
    if (reportTypeSelect && issuesSpecificFields) {
      issuesSpecificFields.style.display = reportTypeSelect.value == 'issues' ? 'block' : 'none';
    }
  }
  if (reportTypeSelect) {
    reportTypeSelect.addEventListener('change', toggleFields);
    toggleFields(); 
  }
  
  // –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
  const searchInput = document.getElementById('recipient_search');
  const addButton = document.getElementById('add_recipient_btn');
  const tbody = document.getElementById('recipients_tbody');
  let currentSelection = null;
  let searchTimeout;

  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      
      if (query.length < 2) {
        addButton.disabled = true;
        currentSelection = null;
        return;
      }

      searchTimeout = setTimeout(() => {
        fetch('/admin/email_reports/available_principals?q=' + encodeURIComponent(query))
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              currentSelection = data[0];
              searchInput.title = "–ù–∞–π–¥–µ–Ω–æ: " + currentSelection.name;
              addButton.disabled = false;
              addButton.value = "–î–æ–±–∞–≤–∏—Ç—å: " + currentSelection.name;
            } else {
              addButton.disabled = true;
              currentSelection = null;
              addButton.value = "–î–æ–±–∞–≤–∏—Ç—å";
            }
          });
      }, 300);
    });
  }

  if (addButton) {
    addButton.addEventListener('click', function() {
      if (!currentSelection) return;
      addRecipientRow(currentSelection);
      searchInput.value = '';
      addButton.disabled = true;
      addButton.value = '–î–æ–±–∞–≤–∏—Ç—å';
      currentSelection = null;
    });
  }

  function addRecipientRow(item) {
    const timestamp = new Date().getTime();
    const row = document.createElement('tr');
    row.className = 'recipient-row';
    
    let displayType = item.type === 'User' ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${item.extra || ''}` : '–ì—Ä—É–ø–ø–∞';
    let iconClass = item.type === 'User' ? 'icon icon-user' : 'icon-group';

    row.innerHTML = `
      <td style="padding-left: 10px;">
        <span class="${iconClass}">
          <strong>${item.name}</strong>
        </span>
        <input type="hidden" name="recipients_data[${timestamp}][id]" value="${item.id}">
        <input type="hidden" name="recipients_data[${timestamp}][type]" value="${item.type}">
      </td>
      <td>${displayType}</td>
      <td style="text-align: center;">
        <a href="#" class="icon icon-del" onclick="removeRow(this); return false;"></a>
      </td>
    `;
    
    tbody.appendChild(row);
  }
});

window.removeRow = function(link) {
  link.closest('tr').remove();
}
</script>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/email_reports/index.html.erb
################################################################################
<h2><%= l(:label_email_reports) %></h2>

<div class="contextual">
  <%= link_to l(:label_email_report_new), new_email_report_path, class: 'icon icon-add' %>
</div>

<% if @email_reports.any? %>
  <table class="list">
    <thead>
      <tr>
        <th><%= l(:field_name) %></th>
        <th><%= l(:field_description) %></th>
        <th><%= l(:label_email_report_schedule_type) %></th>
        <th>–ì—Ä—É–ø–ø–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞</th>
        <th><%= l(:field_author) %></th>
        <th><%= l(:field_is_active) %></th>
        <th><%= l(:label_email_report_last_sent) %></th>
        <th>–°–ª–µ–¥—É—é—â–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞</th>
        <th style="width: 10%;"><%= l(:label_actions) %></th>
      </tr>
    </thead>
    <tbody>
      <% @email_reports.each do |report| %>
        <tr>
          <td><%= link_to report.name, edit_email_report_path(report) %></td>
          <td style="color:#888;"><%= truncate(report.description.to_s, length: 40) %></td>
          <td><%= l("label_email_report_schedule_#{report.schedule_type}") %></td>
          <td><%= report.source_group ? report.source_group.lastname : '-' %></td>
          <td><%= report.author.name %></td>
          <td align="center">
            <% if report.is_active %>
              <span class="icon icon-checked" title="<%= l(:general_text_yes) %>"></span>
            <% else %>
              <span class="icon icon-locked" title="<%= l(:general_text_no) %>" style="opacity: 0.5;"></span>
            <% end %>
          </td>
          
          <!-- –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞ -->
          <td><%= report.last_sent_at ? format_time(report.last_sent_at) : '-' %></td>
          
                    <!-- –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê –°–õ–ï–î–£–Æ–©–ï–ô –î–ê–¢–´ -->
          <td>
            <% 
               next_run_date = nil
               if report.is_active && report.send_time
                 # 1. –ë–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                 now = Time.now
                 msk_zone = ActiveSupport::TimeZone.new('Europe/Moscow')
                 now_msk = now.in_time_zone(msk_zone)
                 
                 target_hour = report.send_time.strftime('%H').to_i
                 target_min = report.send_time.strftime('%M').to_i
                 
                 # –°–æ–±–∏—Ä–∞–µ–º –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ "—Å–µ–≥–æ–¥–Ω—è"
                 candidate = now_msk.change(hour: target_hour, min: target_min, sec: 0)
                 
                 case report.schedule_type
                 when 'daily'
                   # –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è, —Ç–æ –∑–∞–≤—Ç—Ä–∞
                   next_run_date = (candidate > now_msk) ? candidate : candidate + 1.day
                   
                 when 'weekly'
                   # –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏–∑ –±–∞–∑—ã (1=–ü–Ω, ..., 6=–°–±, 0=–í—Å)
                   days = report.schedule_cron.to_s.split(',').map(&:to_i)
                   days = [1] if days.empty? # –î–µ—Ñ–æ–ª—Ç –ü–Ω
                   
                   # –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π –¥–µ–Ω—å –Ω–∞—á–∏–Ω–∞—è —Å —Å–µ–≥–æ–¥–Ω—è (0..6 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥)
                   found_date = nil
                   (0..7).each do |offset|
                     check_date = candidate + offset.days
                     # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–Ω—è –Ω–µ–¥–µ–ª–∏
                     if days.include?(check_date.wday)
                       # –ï—Å–ª–∏ —ç—Ç–æ —Å–µ–≥–æ–¥–Ω—è, –Ω–æ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                       if offset == 0 && check_date <= now_msk
                         next
                       end
                       found_date = check_date
                       break
                     end
                   end
                   next_run_date = found_date
                   
                 when 'monthly'
                   # 1-–µ —á–∏—Å–ª–æ –º–µ—Å—è—Ü–∞
                   this_month_run = candidate.change(day: 1)
                   if this_month_run > now_msk
                      next_run_date = this_month_run
                   else
                      next_run_date = this_month_run + 1.month
                   end
                 end
               end
            %>

            <% if next_run_date %>
              <!-- –§–æ—Ä–º–∞—Ç: 27.11.2025 | –ß–µ—Ç–≤–µ—Ä–≥ –≤ 08:00 -->
              <strong><%= next_run_date.strftime("%d.%m.%Y") %></strong>
              <br>
              <span style="color: #666; font-size: 0.9em;">
                <!-- day_name(wday) - —Ö–µ–ª–ø–µ—Ä Redmine –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–Ω—è –Ω–µ–¥–µ–ª–∏ -->
                <%= day_name(next_run_date.wday) %> –≤ <%= next_run_date.strftime("%H:%M") %>
              </span>
            <% else %>
              <span style="color: #999;">-</span>
            <% end %>
          </td>

          <td class="buttons">
            <%= link_to l(:button_test), test_email_report_path(report), method: :post, class: 'icon icon-test', title: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å" %>
            <%= link_to l(:button_edit), edit_email_report_path(report), class: 'icon icon-edit' %>
            <%= delete_link email_report_path(report) %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% end %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/email_reports/new.html.erb
################################################################################
<h2><%= l(:label_email_report_new) %></h2>

<%= error_messages_for @email_report %>

<%= form_for @email_report, url: { action: 'create' } do |f| %>
  <%= render 'form', f: f %>
<% end %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/hooks/email_reports/_project_link.html.erb
################################################################################
<!-- plugins/email_reports/app/views/hooks/email_reports/_project_link.html.erb -->
<% if User.current.allowed_to?(:manage_email_reports, @project) %>
  <div class="email-reports-sidebar">
    <%= link_to l(:label_email_reports), 
        { controller: 'email_reports', action: 'index', project_id: @project },
        class: 'icon icon-email' %>
  </div>
<% end %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/app/views/report_mailer/report_email.html.erb
################################################################################
<!DOCTYPE html>
<html>
<head>
  <meta charset='UTF-8'>
  <title>–û—Ç—á–µ—Ç Redmine</title>
  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      line-height: 1.6;
      color: #343a40; /* Darker grey for text */
      max-width: 1200px;
      margin: 0 auto;
      padding: 25px;
      background-color: #f0f2f5; /* Light grey background */
    }
    .header {
      background: #ffffff; /* White header */
      color: #343a40; /* Dark text for header */
      padding: 40px;
      border-radius: 12px;
      margin-bottom: 35px;
      text-align: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      border-top: 8px solid #007bff; /* Primary blue accent */
    }
    .header h1 {
      margin: 0;
      font-size: 36px;
      font-weight: 700;
      color: #212529; /* Even darker for main title */
    }
    .period {
      font-size: 20px;
      color: #6c757d; /* Muted grey for period */
      margin-top: 15px;
    }
    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border-left: 6px solid #6c757d; /* Muted grey border */
    }
    .section h2 {
      color: #212529;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 26px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 15px;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
    }
    th {
      background: #007bff; /* Primary blue for table headers */
      color: white;
      padding: 15px 18px;
      text-align: left;
      font-weight: 600;
      border: none;
    }
    td {
      padding: 14px 18px;
      border-bottom: 1px solid #dee2e6; /* Light grey border */
      background-color: #ffffff;
    }
    tr:nth-child(even) td {
      background-color: #f8f9fa; /* Slightly off-white for even rows */
    }
    tr:hover td {
      background-color: #e2f2ff; /* Light blue on hover */
    }
    .total-row td {
      background-color: #e0f2f7; /* Light cyan for total */
      font-weight: bold;
      border-top: 2px solid #007bff;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin-bottom: 35px;
    }
    .metric-card {
      background: #ffffff;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      border-top: 6px solid #6c757d; /* Default muted border */
    }
    /* Individual metric card border colors */
    .metric-card.total-closed { border-top-color: #28a745; } /* Green */
    .metric-card.active-users { border-top-color: #007bff; } /* Blue */

    .metric-value {
      font-size: 40px;
      font-weight: 700;
      color: #212529; /* Darker for values */
      margin: 15px 0 10px;
    }
    .metric-label {
      color: #6c757d;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-open { color: #dc3545; font-weight: bold; } /* Red */
    .status-in-progress { color: #ffc107; font-weight: bold; } /* Yellow/Orange */
    .status-closed { color: #28a745; font-weight: bold; } /* Green */
    .user-avatar {
      display: inline-flex; /* Use flex for perfect centering */
      align-items: center;
      justify-content: center;
      width: 40px; /* Slightly larger */
      height: 40px;
      background: #007bff; /* Primary blue */
      color: white;
      border-radius: 50%;
      font-weight: bold;
      font-size: 16px;
      margin-right: 10px;
      vertical-align: middle;
      flex-shrink: 0; /* Prevent shrinking in flex container */
    }
    .user-section {
      margin-bottom: 22px;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      overflow: hidden;
    }
    .user-summary {
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .no-activity {
      background-color: #fff3cd; /* Light warning yellow */
      color: #856404;
    }
    .has-activity {
      background-color: #d4edda; /* Light success green */
      color: #155724;
    }
    .user-stats {
      padding: 8px 15px;
      background: white;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      border: 1px solid #ced4da;
    }
    .user-details-content {
      padding: 20px;
      background-color: #f8f9fa;
      border-top: 1px solid #e9ecef;
    }
    .section-title {
      color: #212529;
      margin-top: 35px;
      margin-bottom: 20px;
      font-size: 22px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e9ecef;
      font-weight: 600;
    }
    .user-row td {
        background-color: #e9f0f9 !important; /* Lighter blue for user rows in tables */
        font-weight: 600;
        border-top: 2px solid #cce5ff; /* Light blue border */
    }
    .user-row .user-avatar {
        background: #0056b3; /* Darker blue for avatars in user rows */
    }
    .footer {
      text-align: center;
      margin-top: 50px;
      color: #6c757d;
      font-size: 14px;
      border-top: 1px solid #e9ecef;
      padding-top: 25px;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class='header'>
    <h1>–û—Ç—á–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Redmine</h1>
    <div class='period'>
      –ü–µ—Ä–∏–æ–¥: <b><%= @data[:start_date] %> - <%= @data[:end_date] %></b>
    </div>
  </div>

  <!-- METRICS -->
  <div class='metrics'>
    <div class='metric-card total-closed'>
      <div class='metric-label'>–ó–∞–¥–∞—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
      <div class='metric-value'><%= @data[:closed_issues_count] || 0 %></div>
      <div>–∑–∞–∫—Ä—ã—Ç—ã –≤ –ø–µ—Ä–∏–æ–¥</div>
    </div>
    <% 
      group_users_count = @data[:group_users] ? @data[:group_users].count : 0
      active_users_count = @data[:closed_issues_by_user] ? @data[:closed_issues_by_user].count : 0
    %>
    <div class='metric-card active-users'>
      <div class='metric-label'>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
      <div class='metric-value'><%= active_users_count %>/<%= group_users_count %></div>
      <div>–∑–∞–∫—Ä—ã–≤–∞–ª–∏ –∑–∞—è–≤–∫–∏</div>
    </div>
  </div>

  <!-- USER ACTIVITY -->
  <% if @data[:group_users] && @data[:group_users].any? %>
    <div class='section'>
      <h2>üë• –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä—É–ø–ø—ã (–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏)</h2>
      
      <% 
        # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö: —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
        closed_counts = @data[:closed_issues_by_user].map { |row| [row['user_id'].to_i, row['closed_count'].to_i] }.to_h
        active_users = []
        inactive_users = []
        
        @data[:group_users].each do |user|
          user_id = user['id'].to_i
          closed_count = closed_counts[user_id] || 0
          if closed_count > 0
            active_users << { 'user' => user, 'closed_count' => closed_count }
          else
            inactive_users << { 'user' => user, 'closed_count' => closed_count }
          end
        end
        
        # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        active_users.sort_by! { |d| -d['closed_count'] }
      %>

      <!-- Inactive Users Section -->
      <% if inactive_users.any? %>
        <div class='section-title'>üôÖ‚Äç‚ôÇÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∑–∞–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫</div>
        <% inactive_users.each do |d| %>
          <% user = d['user'] %>
          <% user_initials = "#{user['firstname'][0]}#{user['lastname'][0]}" %>
          <div class='user-section'>
            <div class='user-summary no-activity'>
              <div>
                <span class='user-avatar'><%= user_initials %></span>
                <strong><%= "#{user['firstname']} #{user['lastname']}" %></strong>
              </div>
              <span class='user-stats'>–ó–∞–∫—Ä—ã—Ç–æ –∑–∞–¥–∞—á: <%= d['closed_count'] %></span>
            </div>
          </div>
        <% end %>
      <% end %>

      <!-- Active Users Section -->
      <% if active_users.any? %>
        <div class='section-title'>‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        <% active_users.each do |d| %>
          <% user = d['user'] %>
          <% user_id = user['id'].to_i %>
          <% user_initials = "#{user['firstname'][0]}#{user['lastname'][0]}" %>
          
          <div class='user-section'>
            <div class='user-summary has-activity'>
              <div>
                <span class='user-avatar'><%= user_initials %></span>
                <strong><%= "#{user['firstname']} #{user['lastname']}" %></strong>
              </div>
              <span class='user-stats'>–ó–∞–∫—Ä—ã—Ç–æ –∑–∞–¥–∞—á: <%= d['closed_count'] %></span>
            </div>
            
            <%# –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∏–∑ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –º–æ–¥–µ–ª–∏ %>
            <% 
               source_user_data = @data[:closed_issues_by_user].find { |u| u['user_id'].to_i == user_id }
               details = source_user_data ? source_user_data['_closed_issues_details'] : []
            %>
            
            <% if details && details.any? %>
              <div class='user-details-content'>
                <table>
                  <tr><th>ID –∑–∞–¥–∞—á–∏</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
                  <% details.each do |issue| %>
                    <% 
                      closed_date = issue['closed_date'] ? issue['closed_date'][0, 10] : (issue['closed_on'] ? issue['closed_on'][0, 10] : '‚Äî')
                      status_class = issue['status_name'].downcase.include?('–∑–∞–∫—Ä') || issue['status_name'].downcase.include?('closed') ? 'status-closed' : 'status-open'
                      subject = issue['subject']
                      subject_short = subject.length > 80 ? "#{subject[0..77]}..." : subject
                      issue_link = "#{Setting.protocol}://#{Setting.host_name}/issues/#{issue['issue_id']}"
                    %>
                    <tr>
                      <td><a href='<%= issue_link %>' target='_blank' style='text-decoration:none; color:#007bff;'><strong>#<%= issue['issue_id'] %></strong></a></td>
                      <td title='<%= subject %>'><%= subject_short %></td>
                      <td><%= issue['created_on'][0, 10] %></td>
                      <td><%= closed_date %></td>
                      <td><span class='<%= status_class %>'><%= issue['status_name'] %></span></td>
                    </tr>
                  <% end %>
                </table>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- ASSIGNED OPEN ISSUES -->
  <% if @data[:assigned_open_issues] && @data[:assigned_open_issues].any? %>
    <div class='section'>
      <h2>üë§ –û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏ (—Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º –∏–∑ –≥—Ä—É–ø–ø—ã)</h2>
      <table>
        <tr><th>ID</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ê–≤—Ç–æ—Ä</th></tr>
        <% @data[:assigned_open_issues].group_by { |i| i['assigned_to_id'].to_i }.each do |assignee_id, issues| %>
          <% assignee = issues.first %>
          <% user_initials = "#{assignee['assignee_firstname'][0]}#{assignee['assignee_lastname'][0]}" %>
          <tr class='user-row'>
            <td colspan='5'>
              <span class='user-avatar'><%= user_initials %></span>
              <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: <%= "#{assignee['assignee_firstname']} #{assignee['assignee_lastname']}" %></strong>
            </td>
          </tr>
          <% issues.each do |issue| %>
            <% 
              status_class = case issue['status_name'].downcase
              when /–≤ —Ä–∞–±–æ—Ç–µ|in progress/i then 'status-in-progress'
              else 'status-open'
              end
              subject = issue['subject']
              subject_short = subject.length > 80 ? "#{subject[0..77]}..." : subject
              issue_link = "#{Setting.protocol}://#{Setting.host_name}/issues/#{issue['id']}"
            %>
            <tr>
              <td><a href='<%= issue_link %>' target='_blank' style='text-decoration:none; color:#007bff;'><strong>#<%= issue['id'] %></strong></a></td>
              <td title='<%= subject %>'><%= subject_short %></td>
              <td><%= issue['created_on'][0, 10] %></td>
              <td><span class='<%= status_class %>'><%= issue['status_name'] %></span></td>
              <td><%= "#{issue['author_firstname']} #{issue['author_lastname']}" %></td>
            </tr>
          <% end %>
        <% end %>
      </table>
    </div>
  <% elsif @data[:assigned_open_issues] %>
    <div class='section'>
      <h2>üë§ –û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏ (—Å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º –∏–∑ –≥—Ä—É–ø–ø—ã)</h2>
      <p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≥—Ä—É–ø–ø—ã.</p>
    </div>
  <% end %>

  <!-- UNASSIGNED OPEN ISSUES -->
  <% if @data[:unassigned_open_issues] && @data[:unassigned_open_issues].any? %>
    <div class='section'>
      <h2>‚ùì –û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏ –±–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h2>
      <table>
        <tr><th>ID</th><th>–¢–µ–º–∞</th><th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ê–≤—Ç–æ—Ä</th></tr>
        <% @data[:unassigned_open_issues].each do |issue| %>
          <% 
            status_class = case issue['status_name'].downcase
            when /–≤ —Ä–∞–±–æ—Ç–µ|in progress/i then 'status-in-progress'
            else 'status-open'
            end
            subject = issue['subject']
            subject_short = subject.length > 80 ? "#{subject[0..77]}..." : subject
            issue_link = "#{Setting.protocol}://#{Setting.host_name}/issues/#{issue['id']}"
          %>
          <tr>
            <td><a href='<%= issue_link %>' target='_blank' style='text-decoration:none; color:#007bff;'><strong>#<%= issue['id'] %></strong></a></td>
            <td title='<%= subject %>'><%= subject_short %></td>
            <td><%= issue['created_on'][0, 10] %></td>
            <td><span class='<%= status_class %>'><%= issue['status_name'] %></span></td>
            <td><%= "#{issue['author_firstname']} #{issue['author_lastname']}" %></td>
          </tr>
        <% end %>
      </table>
    </div>
  <% elsif @data[:unassigned_open_issues] %>
    <div class='section'>
      <h2>‚ùì –û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏ –±–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h2>
      <p>–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫ –±–µ–∑ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.</p>
    </div>
  <% end %>

  <!-- FOOTER -->
  <div class='footer'>
    <p>–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Ä¢ <%= Date.today %> ‚Ä¢ –ì—Ä—É–ø–ø–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è: #<%= @report.source_group&.id %> / –ì—Ä—É–ø–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: #<%= @report.recipient_group&.id %></p>
  </div>

</body>
</html>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/config/locales/en.yml
################################################################################
en:
  label_email_reports: Email Reports
  label_email_report_new: New email report
  label_email_report_edit: Edit email report
  label_email_report_schedule_type: Schedule
  label_email_report_schedule_daily: Daily
  label_email_report_schedule_weekly: Weekly
  label_email_report_schedule_monthly: Monthly
  label_email_report_schedule_custom: Custom (cron)
  label_email_report_schedule_cron: Cron expression
  text_email_report_cron_help: 'Format: minute hour day month weekday (e.g., 0 8 * * 1)'
  label_email_report_send_time: Send time
  label_email_report_type: Report type
  label_email_report_type_issues: Issues
  label_email_report_type_time_entries: Time entries
  label_email_report_group_by: Group by
  label_email_report_recipients: Recipients
  label_email_report_add_recipient: Add recipient
  label_email_report_last_sent: Last sent
  label_email_report_filters: Filters
  label_email_report_add_filter: Add filter
  label_email_report_columns: Columns
  label_email_report_add_column: Add column
  label_email_reports_settings: Email Reports Settings
  label_smtp_timeout: SMTP timeout
  label_max_recipients: Max recipients
  button_test: Test
  notice_email_report_test_sent: Test email sent successfully
  notice_email_report_test_failed: Test email failed
  notice_email_report_activated: Report activated
  notice_email_report_deactivated: Report deactivated
  notice_email_report_created: Report created successfully
  notice_email_report_updated: Report updated successfully
  notice_email_report_deleted: Report deleted successfully
  field_name: Name
  field_description: Description
  field_project: Project
  field_author: Author
  field_is_active: Active
  field_status: Status
  field_priority: Priority
  field_assigned_to: Assigned to
  field_category: Category
  field_tracker: Tracker
  label_actions: Actions
  label_no_data: No data
  button_edit: Edit
  button_delete: Delete
  button_save: Save
  general_text_yes: "Yes"
  general_text_no: "No"



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/config/locales/ru.yml
################################################################################
ru:
  label_email_reports: Email –æ—Ç—á—ë—Ç—ã
  label_email_report_new: –ù–æ–≤—ã–π email –æ—Ç—á—ë—Ç
  label_email_report_edit: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å email –æ—Ç—á—ë—Ç
  label_email_report_schedule_type: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  label_email_report_schedule_daily: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ
  label_email_report_schedule_weekly: –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
  label_email_report_schedule_monthly: –ï–∂–µ–º–µ—Å—è—á–Ω–æ
  label_email_report_schedule_custom: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ (cron)
  label_email_report_schedule_cron: Cron –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
  text_email_report_cron_help: '–§–æ—Ä–º–∞—Ç: –º–∏–Ω—É—Ç–∞ —á–∞—Å –¥–µ–Ω—å –º–µ—Å—è—Ü –¥–µ–Ω—å_–Ω–µ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0 8 * * 1)'
  label_email_report_send_time: –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
  label_email_report_type: –¢–∏–ø –æ—Ç—á—ë—Ç–∞
  label_email_report_type_issues: –ó–∞–¥–∞—á–∏
  label_email_report_type_time_entries: –¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã
  label_email_report_group_by: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ
  label_email_report_recipients: –ü–æ–ª—É—á–∞—Ç–µ–ª–∏
  label_email_report_add_recipient: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
  label_email_report_last_sent: –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞
  label_email_report_filters: –§–∏–ª—å—Ç—Ä—ã
  label_email_report_add_filter: –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
  label_email_report_columns: –ö–æ–ª–æ–Ω–∫–∏
  label_email_report_add_column: –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É
  label_email_reports_settings: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Email –æ—Ç—á—ë—Ç–æ–≤
  label_smtp_timeout: SMTP —Ç–∞–π–º–∞—É—Ç
  label_max_recipients: –ú–∞–∫—Å–∏–º—É–º –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
  button_test: –¢–µ—Å—Ç
  notice_email_report_test_sent: –¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
  notice_email_report_test_failed: –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∏—Å—å–º–∞
  notice_email_report_activated: –û—Ç—á—ë—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
  notice_email_report_deactivated: –û—Ç—á—ë—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
  notice_email_report_created: –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω
  notice_email_report_updated: –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω
  notice_email_report_deleted: –û—Ç—á—ë—Ç —É–¥–∞–ª—ë–Ω
  field_name: –ù–∞–∑–≤–∞–Ω–∏–µ
  field_description: –û–ø–∏—Å–∞–Ω–∏–µ
  field_project: –ü—Ä–æ–µ–∫—Ç
  field_author: –ê–≤—Ç–æ—Ä
  field_is_active: –ê–∫—Ç–∏–≤–µ–Ω
  field_status: –°—Ç–∞—Ç—É—Å
  field_priority: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
  field_assigned_to: –ù–∞–∑–Ω–∞—á–µ–Ω–∞
  field_category: –ö–∞—Ç–µ–≥–æ—Ä–∏—è
  field_tracker: –¢—Ä–µ–∫–µ—Ä
  label_actions: –î–µ–π—Å—Ç–≤–∏—è
  label_no_data: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  button_edit: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
  button_delete: –£–¥–∞–ª–∏—Ç—å
  button_save: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
  general_text_yes: "–î–∞"
  general_text_no: "–ù–µ—Ç"



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/config/routes.rb
################################################################################
Rails.application.routes.draw do
  scope '/admin' do
    resources :email_reports do
      member do
        post :test
        post :toggle_active
      end
      collection do
        get :available_principals
      end
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/db/migrate/20251120200000_setup_email_reports.rb
################################################################################
class SetupEmailReports < ActiveRecord::Migration[7.0]
  def change
    # 1. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –æ—Ç—á–µ—Ç–æ–≤ (email_reports)
    create_table :email_reports do |t|
      t.string :name                        # –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞
      t.text :description                   # –û–ø–∏—Å–∞–Ω–∏–µ
      t.string :schedule_type, default: 'weekly'  # –¢–∏–ø —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è (daily, weekly)
      t.string :schedule_cron               # Cron-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      t.time :send_time                     # –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
      t.integer :report_period_days, default: 7   # –ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞ –≤ –¥–Ω—è—Ö
      
      t.string :report_type, default: 'issues'    # –¢–∏–ø –æ—Ç—á–µ—Ç–∞ (issues, time_entries)
      t.string :group_by                    # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
      t.integer :project_id                 # ID –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –æ—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É)
      t.integer :author_id                  # –ê–≤—Ç–æ—Ä –æ—Ç—á–µ—Ç–∞
      t.integer :source_group_id            # –ì—Ä—É–ø–ø–∞-–∏—Å—Ç–æ—á–Ω–∏–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      
      t.boolean :is_active, default: true   # –ê–∫—Ç–∏–≤–µ–Ω –ª–∏ –æ—Ç—á–µ—Ç
      
      # –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä (–º–∞—Å—Å–∏–≤—ã, —Ö–µ—à–∏)
      t.text :query_filters                 # –§–∏–ª—å—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (JSON/YAML)
      t.text :columns                       # –°–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ (JSON/YAML)
      
      t.timestamps
    end

    # –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è email_reports
    add_index :email_reports, :author_id
    add_index :email_reports, :project_id
    add_index :email_reports, :is_active

    # 2. –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (email_report_recipients)
    create_table :email_report_recipients do |t|
      t.references :email_report, foreign_key: true
      
      t.string :recipient_type   # 'user', 'group', 'email'
      t.integer :recipient_id    # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—ã
      t.string :email            # Email (–µ—Å–ª–∏ –≤–Ω–µ—à–Ω–∏–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å)
      
      t.timestamps
    end

    # –ò–Ω–¥–µ–∫—Å —Å –∫–æ—Ä–æ—Ç–∫–∏–º –∏–º–µ–Ω–µ–º –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
    add_index :email_report_recipients, [:recipient_type, :recipient_id], name: 'idx_email_rep_recip_on_type_id'
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/db/migrate/20251120201500_add_last_sent_at_to_email_reports.rb
################################################################################
class AddLastSentAtToEmailReports < ActiveRecord::Migration[7.0]
  def change
    add_column :email_reports, :last_sent_at, :datetime
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/init.rb
################################################################################
require 'redmine'

Redmine::Plugin.register :email_reports do
  name 'Email Reports'
  author 'RodionovSA'
  description 'Generate and send automated email reports'
  version '1.4.0'
  
  permission :manage_email_reports, {
    email_reports: [:index, :show, :new, :create, :edit, :update, :destroy, :test, :toggle_active, :available_principals]
  }, require: :member
  
  menu :admin_menu, :email_reports,
       { controller: 'email_reports', action: 'index' },
       caption: :label_email_reports,
       html: { class: 'icon' }
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/lib/email_reports/hooks.rb
################################################################################
# plugins/email_reports/lib/email_reports/hooks.rb
module EmailReports
  class Hooks < Redmine::Hook::ViewListener
    # –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –≤ –º–µ–Ω—é –ø—Ä–æ–µ–∫—Ç–∞
    render_on :view_projects_show_sidebar,
              partial: 'hooks/email_reports/project_link'
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/lib/tasks/email_reports.rake
################################################################################
namespace :email_reports do
  desc "Send pending email reports"
  task send_pending: :environment do
    EmailReport.active.ready_to_send.find_each do |report|
      EmailReportJob.perform_later(report.id)
    end
  end

  desc "Initialize demo email reports"
  task init_demo: :environment do
    group = Group.find_or_create_by!(lastname: 'Test Email Reports') do |g|
      g.users = User.where(admin: true).limit(3)
    end
    
    project = Project.active.first
    
    report = EmailReport.create!(
      name: "Demo Weekly Report",
      description: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –æ—Ç—á—ë—Ç",
      schedule_type: "weekly",
      send_time: Time.parse("09:00"),
      author: User.active.admin.first,
      project: project,
      report_type: "issues",
      query_filters: {
        "status_id" => { "operator" => "o", "values" => [""] },
        "assigned_to_id" => { "operator" => "=", "values" => ["me"] }
      },
      columns: ["id", "subject", "status", "assigned_to", "updated_on"],
      group_by: "status",
      is_active: true
    )

    report.recipients.create!(recipient_type: "group", recipient_id: group.id)
    
    puts "‚úÖ Demo –æ—Ç—á—ë—Ç —Å–æ–∑–¥–∞–Ω: ID=#{report.id}"
    puts "üë• –ì—Ä—É–ø–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: #{group.lastname} (#{group.users.count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)"
    puts "üìä –¢–∏–ø –æ—Ç—á—ë—Ç–∞: #{report.report_type}"
    puts "‚è∞ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: #{report.schedule_type} –≤ #{report.send_time.strftime('%H:%M')}"
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/lib/tasks/send_pending.rake
################################################################################
namespace :email_reports do
  desc "Send pending email reports based on schedule"
  task send_pending: :environment do
    # 1. –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ú–æ—Å–∫–≤–µ
    msk_zone = ActiveSupport::TimeZone.new('Europe/Moscow')
    now_msk = Time.now.in_time_zone(msk_zone)
    
    Rails.logger.info "---------------------------------------------------"
    Rails.logger.info "EmailReports: Checking schedule at #{now_msk}"

    EmailReport.active.find_each do |report|
      unless report.send_time
        Rails.logger.info "Report ##{report.id}: No send_time set."
        next
      end

      # 2. –ü–æ–ª—É—á–∞–µ–º "—Ü–µ–ª–µ–≤–æ–µ" –≤—Ä–µ–º—è –∏–∑ –ë–î
      target_hour = report.send_time.strftime('%H').to_i
      target_min = report.send_time.strftime('%M').to_i

      Rails.logger.info "Report ##{report.id} ('#{report.name}'):"
      Rails.logger.info "  - Target Time (DB): #{target_hour.to_s.rjust(2, '0')}:#{target_min.to_s.rjust(2, '0')}"
      Rails.logger.info "  - Current Time (MSK): #{now_msk.hour.to_s.rjust(2, '0')}:#{now_msk.min.to_s.rjust(2, '0')}"

      # 3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å –æ–∫–Ω–æ–º –≤ 5 –º–∏–Ω—É—Ç
      # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É, –µ—Å–ª–∏ –∫—Ä–æ–Ω –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –≤ 12:00:05 –∏–ª–∏ 12:02:00
      is_time_match = now_msk.hour == target_hour && 
                      now_msk.min >= target_min && 
                      now_msk.min < (target_min + 5)

      Rails.logger.info "  - Time window match? #{is_time_match ? 'YES' : 'NO'}"

      if is_time_match
        # === –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò –î–ù–Ø ===
        should_run_today = false
        
        case report.schedule_type
        when 'daily'
          should_run_today = true
        when 'weekly'
          # –ï—Å–ª–∏ –≤ schedule_cron —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "1,3,5"), –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
          # –ï—Å–ª–∏ –ø—É—Å—Ç–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (1)
          # 0=–í—Å, 1=–ü–Ω, ... 6=–°–±
          target_days = report.schedule_cron.present? ? report.schedule_cron.split(',').map(&:to_i) : [1]
          should_run_today = target_days.include?(now_msk.wday)
          Rails.logger.info "  - Weekly check: Today is #{now_msk.wday}. Targets: #{target_days}. Match? #{should_run_today}"
        when 'monthly'
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º 1-–≥–æ —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞
          should_run_today = (now_msk.day == 1)
        else
          # Custom cron –∏–ª–∏ –∏–Ω–æ–µ - –ø–æ–∫–∞ —Ä–∞–∑—Ä–µ—à–∞–µ–º, –µ—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–≤–ø–∞–ª–æ
          should_run_today = true
        end

        Rails.logger.info "  - Schedule (Day) match? #{should_run_today}"

        # === –ü–†–û–í–ï–†–ö–ê –ü–û–í–¢–û–†–ù–û–ô –û–¢–ü–†–ê–í–ö–ò ===
        # –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        already_sent_today = false
        
        if report.last_sent_at
          last_sent_msk = report.last_sent_at.in_time_zone(msk_zone)
          
          # –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É –æ—Ç—Å—á–µ—Ç–∞: —Å–µ–≥–æ–¥–Ω—è –≤ —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞
          today_window_start = now_msk.change(hour: target_hour, min: target_min, sec: 0)
          
          # –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—ã–ª–∞ –ø–æ–∑–∂–µ –Ω–∞—á–∞–ª–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –æ–∫–Ω–∞ - –∑–Ω–∞—á–∏—Ç —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
          if last_sent_msk >= today_window_start
            already_sent_today = true
          end
        end

        if already_sent_today
          Rails.logger.info "  - Already sent today? YES (Last sent: #{report.last_sent_at})"
          next 
        else
          Rails.logger.info "  - Already sent today? NO"
        end

        # === –§–ò–ù–ê–õ–¨–ù–´–ô –ó–ê–ü–£–°–ö ===
        if should_run_today
          begin
            Rails.logger.info "  => SENDING NOW..."
            EmailReportJob.perform_now(report.id)
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            report.update_column(:last_sent_at, Time.now.utc)
            Rails.logger.info "  => SENT SUCCESS."
          rescue => e
            Rails.logger.error "  => ERROR: #{e.message}"
            Rails.logger.error e.backtrace.join("\n")
          end
        else
          Rails.logger.info "  => Skipping (Not the right day)."
        end
      end
    end
    Rails.logger.info "---------------------------------------------------"
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/README.rdoc
################################################################################
= email_reports

Description goes here



################################################################################
üìÑ FILE: ./storage/redmine/plugins/email_reports/test/test_helper.rb
################################################################################
# Load the Redmine helper
require_relative '../../../test/test_helper'



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/app/views/settings/_force_time_settings.html.erb
################################################################################
<p>
  <label><b>ID –ü—Ä–æ–µ–∫—Ç–æ–≤</b> (–ø—É—Å—Ç–æ = –≤–æ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö):</label><br>
  <%= text_field_tag 'settings[projects]', Setting.plugin_redmine_force_time2['projects'], size: 50, placeholder: '1, 12, 5' %>
  <br><em>–£–∫–∞–∂–∏—Ç–µ ID –ø—Ä–æ–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. ID –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ URL –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤.</em>
</p>

<hr>

<p>
  <label>ID –°—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫—Ä—ã—Ç–∏—è:</label><br>
  <%= text_field_tag 'settings[statuses]', Setting.plugin_redmine_force_time2['statuses'], size: 30 %>
</p>

<p>
  <label>–û—à–∏–±–∫–∞ (–Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏):</label><br>
  <%= text_field_tag 'settings[message_time]', Setting.plugin_redmine_force_time2['message_time'], size: 80 %>
</p>

<p>
  <label>–û—à–∏–±–∫–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏—è '–ü—Ä–æ—á–µ–µ'):</label><br>
  <%= text_field_tag 'settings[message_category]', Setting.plugin_redmine_force_time2['message_category'], size: 80 %>
</p>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/assets/javascripts/force_time_blocker.js
################################################################################
// UI –ë–õ–û–ö–ò–†–û–í–ö–ê: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.querySelector('#issue_status_id');
    const timeEntryHours = document.querySelector('#time_entry_hours');
    const submitButton = document.querySelector('input[name=commit]');
    
    
    function validateTime() {
      const statusId = statusSelect.value;
      const hours = parseFloat(timeEntryHours?.value || '0');
      const requiredStatuses = ['5']; // –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
      
      if (requiredStatuses.includes(statusId) && hours <= 0) {
        submitButton.disabled = true;
        submitButton.title = 'üö´ –î–æ–±–∞–≤—å—Ç–µ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã!';
        if (timeEntryHours) timeEntryHours.style.border = '2px solid red';
        return false;
      }
      
      submitButton.disabled = false;
      submitButton.title = '';
      if (timeEntryHours) timeEntryHours.style.border = '';
      return true;
    }
    
    statusSelect.addEventListener('change', validateTime);
    if (timeEntryHours) timeEntryHours.addEventListener('input', validateTime);
    validateTime(); // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  });
})();



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/assets/javascripts/force_time.js
################################################################################
(function() {
  var form = document.getElementById(\"issue-form\");
  if (!form) return;
  
  var statusSelect = document.getElementById(\"issue_status_id\");
  var hoursField = document.querySelector(\"input[name*=hours]\");
  var submitBtn = form.querySelector(\"input[type=submit]\");
  
  if (!statusSelect || !submitBtn) return;
  
  function validate() {
    var statusId = statusSelect.value;
    var hours = parseFloat(hoursField ? hoursField.value : 0) || 0;
    if (statusId == \"5\" && hours <= 0) {
      submitBtn.disabled = true;
      submitBtn.value = \"–î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–º—è!\";
      if (hoursField) hoursField.style.border = \"3px solid red\";
    } else {
      submitBtn.disabled = false;
      submitBtn.value = \"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å\";
      if (hoursField) hoursField.style.border = \"\";
    }
  }
  
  statusSelect.addEventListener(\"change\", validate);
  if (hoursField) hoursField.addEventListener(\"input\", validate);
  validate();
})();



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/assets/javascripts/force_time_ui.js
################################################################################
(function() {
  'use strict';
  
  const statusSelect = document.querySelector('#issue_status_id');
  const hoursField = document.querySelector('#time_entry_hours, input[name*="hours"]');
  const submitBtn = document.querySelector('input[type="submit"], input[name="commit"]');
  
  
  function checkTimeEntry() {
    const statusId = statusSelect.value;
    const hours = parseFloat(hoursField?.value || 0);
    const requiredStatuses = ['5']; // hardcoded –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
    
    if (requiredStatuses.includes(statusId) && hours <= 0) {
      submitBtn.disabled = true;
      submitBtn.value = 'üö´ –î–æ–±–∞–≤—å—Ç–µ –≤—Ä–µ–º—è!';
      if (hoursField) {
        hoursField.style.border = '3px solid #dc3545';
        hoursField.title = '–¢—Ä–µ–±—É—é—Ç—Å—è —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã!';
      }
    } else {
      submitBtn.disabled = false;
      submitBtn.value = submitBtn.defaultValue || '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      if (hoursField) {
        hoursField.style.border = '';
        hoursField.title = '';
      }
    }
  }
  
  statusSelect.addEventListener('change', checkTimeEntry);
  if (hoursField) hoursField.addEventListener('input', checkTimeEntry);
  checkTimeEntry();
})();



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/config/routes.rb
################################################################################
# Plugin's routes
# See: http://guides.rubyonrails.org/routing.html



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/init.rb
################################################################################
require 'redmine'

Redmine::Plugin.register :redmine_force_time2 do
  name 'Force Time BLOCKER'
  author 'RodionovSA'
  version '2.1'
  description '–ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ (—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø—Ä–æ–µ–∫—Ç–æ–≤)'
  
  settings default: {
    'statuses' => '5',
    'projects' => '',
    'message_time' => 'üö´ –ù–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å –±–µ–∑ —Ç—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç!',
    'message_category' => 'üö´ –ù–µ–ª—å–∑—è –∑–∞–∫—Ä—ã—Ç—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π "<<–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ>>". –ò–∑–º–µ–Ω–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!'
  }, partial: 'force_time_settings'
end

class Issue
  alias_method :original_save, :save unless method_defined?(:original_save)
  
  def save(*args)
    settings = Setting.plugin_redmine_force_time2 || {}
    
    # 1. –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
    project_ids = (settings['projects'] || '').split(',').map(&:strip).reject(&:empty?)
    
    # –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç—ã –∑–∞–¥–∞–Ω—ã –∏ —Ç–µ–∫—É—â–∏–π –ù–ï –≤ —Å–ø–∏—Å–∫–µ -> –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏
    if project_ids.any? && !project_ids.include?(project_id.to_s)
      return original_save(*args)
    end

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    required_statuses = (settings['statuses'] || '5').split(',').map(&:strip)
    
    if status_id && required_statuses.include?(status_id.to_s)
      
      # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –í–†–ï–ú–ï–ù–ò
      if time_entries.sum(:hours).to_f <= 0.0
        errors.add(:base, settings['message_time'])
      end

      # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–ê–¢–ï–ì–û–†–ò–ò (ID=1)
      category_val = custom_field_values.detect { |v| v.custom_field_id == 1 }&.value.to_s
      if category_val == '<<–ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ>>'
        errors.add(:base, settings['message_category'])
      end

      if errors[:base].any?
        Rails.logger.error "FORCE_TIME2: BLOCKED ##{id} (Project: #{project_id})"
        return false
      end
    end

    original_save(*args)
  end
end

Rails.logger.info 'FORCE_TIME2 v5: ACTIVE!'



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/README.rdoc
################################################################################
= force_time2

Description goes here



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_force_time2/test/test_helper.rb
################################################################################
# Load the Redmine helper
require_relative '../../../test/test_helper'



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/controllers/recurring_tasks_controller.rb
################################################################################
class RecurringTasksController < ApplicationController
  before_action :set_schedule, only: [:edit, :destroy, :update]
  before_action :set_issue
  before_action :check_permission

  def new
    existing_schedule = RecurringTask.find_by(issue: @issue)
    if existing_schedule
      return redirect_to edit_recurring_task_path(existing_schedule)
    end

    @schedule = RecurringTask.new(tracker: @issue.tracker, issue: @issue)
  end

  def create
    @schedule = RecurringTask.new
    @schedule.issue = @issue
    @schedule.assign_attributes(recurring_task_params)
    if @schedule.save
      redirect_to issue_path(@issue)
    else
      render :new
    end
  end

  def update
    @schedule.assign_attributes(recurring_task_params)
    if @schedule.save
      redirect_to issue_path(@issue)
    else
      render :edit
    end
  end

  def edit
  end

  def destroy
    @schedule.destroy
    redirect_to issue_path(@issue)
  end

  private

  def recurring_task_params
    params.require(:recurring_task).permit(:sunday, :monday, :tuesday, :wednesday,
                                           :thursday, :friday, :saturday, :time, :tracker_id, :client_run_type,
                                           months: [], month_days: [])
  end

  def set_schedule
    @schedule = RecurringTask.find(params[:id])
  rescue ActiveRecord::RecordNotFound
    render_404
  end

  def set_issue
    if @schedule.present?
      @issue = @schedule.issue
    else
      @issue = Issue.find(params[:issue_id])
    end
  rescue ActiveRecord::RecordNotFound
    render_404
  end

  def check_permission
    unless User.current.allowed_to?(:manage_schedule, @issue.project)
      raise ::Unauthorized
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/helpers/recurring_tasks_helper.rb
################################################################################
module RecurringTasksHelper
  def month_names
    standalone_key = 'date.standalone_month_names'
    I18n.exists?(standalone_key) ? I18n.t(standalone_key) : I18n.t('date.month_names')
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/models/recurring_task.rb
################################################################################
class RecurringTask < ActiveRecord::Base
  UnauthorizedError = Class.new(StandardError)

  belongs_to :issue
  belongs_to :tracker

  validates :issue_id,    presence: true, uniqueness: true
  validates :tracker_id,  presence: true

  validates :time, presence: true

  DAYS = %w(monday tuesday wednesday thursday friday saturday sunday).freeze

  RUN_TYPE_W_DAYS = :week_days
  RUN_TYPE_M_DAYS = :month_days

  attr_accessor :client_run_type

  before_save do
    if client_run_type.present?
      if client_run_type == RUN_TYPE_M_DAYS.to_s
        DAYS.each{|d| public_send("#{d}=", false)}
      else
        self.month_days = []
      end
    end
  end

  # @return [Array<String>] array of days when schedule should be executed
  def days
    DAYS.select{|d| public_send(d)}
  end

  def months=(value)
    value ||= default_months
    super(value.to_json)
  end

  def months
    result = super
    JSON.parse(result)
  rescue
    raise result
  end

  def month_days=(value)
    value ||= default_month_days
    super(value.to_json)
  end

  def time=(value)
    value = Time.new(*value.values) if value.is_a?(Hash)

    return super(value.to_time) unless value.respond_to?(:utc)
    super(value.dup.utc)
  end

  def time
    super&.localtime
  end

  def month_days
    result = super
    result = JSON.parse(result)
  rescue
    raise result
  end

  def month_days_parsed
    month_days.map{|x| x == 'last_day' ? Time.now.end_of_month.day.to_s : x}.compact.uniq
  end

  def self.schedules(current_time = Time.now)
    week_day  = current_time.strftime('%A').downcase
    month_day = current_time.day

    # months
    scope = where("months LIKE '%\"#{current_time.month.to_s}\"%'")

    scope.select do |schedule|
      if schedule.month_days.empty?
        # week day
        next unless schedule.public_send(week_day)
      else
        # month day
        month_days = schedule.month_days_parsed
        next unless month_days.include?(month_day.to_s)
      end

      # time
      schedule.time_came?(current_time)
    end
  end

  # @return [Issue] copied issue
  def copy_issue(associations = [])
    return if issue.project.archived? || issue.project.closed?

    settings = Setting.find_by(name: :plugin_redmine_recurring_tasks)&.value || {}

    issue.deep_clone(include: associations, except: %i[parent_id root_id lft rgt created_on updated_on closed_on]) do |original, copy|
      case original
      when Issue
        copy.init_journal(original.author)
        new_author =
          if settings['use_anonymous_user']
            User.anonymous
          else
            unless original.author.allowed_to?(:copy_issues, issue.project)
              raise UnauthorizedError, "User #{original.author.name} (##{original.author.id}) unauthorized to copy issues"
            end
            original.author
          end
        copy.assigned_to = nil if original.assigned_to.blank? || original.assigned_to.status == User::STATUS_LOCKED || user_not_in_project?(original.assigned_to)
        copy.custom_field_values = original.custom_field_values.inject({}) { |h, v| h[v.custom_field_id] = v.value; h }
        copy.author_id = new_author.id
        copy.tracker_id = original.tracker_id
        copy.parent_issue_id = original.parent_id
        copy.done_ratio = 0
        copy.status_id =
          case settings['copied_issue_status']
          when nil
            copy.new_statuses_allowed_to(original.author).sort_by(&:position).first&.id
          when '0'
            original.status_id
          else
            settings['copied_issue_status']
          end
        copy.attachments = original.attachments.map do |attachement|
          attachement.copy(container: original)
        end
        copy.watcher_user_ids = original.watcher_users.select { |u| u.status == User::STATUS_ACTIVE }.map(&:id)

        copy.start_date = Time.now

        if original.due_date.present?
          issue_date = (original.start_date || original.created_on).to_date
          copy.due_date = copy.start_date + (original.due_date - issue_date)
        end
      else
        next
      end
    end.tap(&:save!)
  end

  # @return [Boolean] boolean result of copy issue and save of schedule last try timestamp
  def execute(associations = nil)
    self.last_try_at = Time.now
    copy_issue(associations) && save
  end

  # @return [Symbol] return :month_days if any month days are present, else :week_days
  def run_type
    self.month_days.any? ? RUN_TYPE_M_DAYS : RUN_TYPE_W_DAYS
  end

  def time_came?(current_time = Time.now)
    utc_offset = current_time.utc_offset / 60 / 60
    utc_offset -= 1 if time.in_time_zone(utc_offset).dst?
    time.in_time_zone(utc_offset).strftime('%H%M%S').to_i <= current_time.strftime('%H%M%S').to_i &&
      (last_try_at.nil? || last_try_at.in_time_zone(utc_offset).strftime('%Y%m%d').to_i < current_time.strftime('%Y%m%d').to_i)
  end

  private

  def default_month_days
    []
  end

  def default_months
    (1..12).to_a.map(&:to_s)
  end

  def user_not_in_project?(user)
    !issue.project.members.pluck(:user_id).include?(user.id)
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/views/recurring_tasks/edit.html.erb
################################################################################
<h2><%= l(:project_module_redmine_recurring_tasks) %></h2>

<%= render partial: 'form' %>


################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/views/recurring_tasks/_form.html.erb
################################################################################
<%= form_for @schedule, html: {id: 'recurring_task_form'} do |f| %>
  <div class="box">
    <fieldset class="box tabular"><legend><%= @schedule.issue.subject %></legend>
      <input type="hidden" name="issue_id" value="<%= @schedule.issue.id %>">

      <%= error_messages_for 'schedule' %>

      <style>
        table.weekly-schedule {
          width: 100%;
        }
      </style>

      <script>
        $(document).ready(function() {
          processOption();
        });

        $(document).on('change', 'input[name="recurring_task[client_run_type]"]', function() {
          processOption();
        });

        function processOption() {
          var isMonthDays = $("input[name='recurring_task[client_run_type]']:checked").val().toString() == 'month_days';

          if (isMonthDays) {
            $('#month_days').prop('disabled', false);
            $('input[type="checkbox"].week_day').prop('checked', false);
            $('input[type="checkbox"].week_day').prop('disabled', true);
          } else {
            $('#month_days').prop('disabled', true);
            $('#month_days option').prop('selected', false);
            $('input[type="checkbox"].week_day').prop('disabled', false);
          }
        }
      </script>

      <table class="weekly-schedule">
        <tr>
          <td valign="top" width="20%">
            <p>
              <label>
                <%= RecurringTask.human_attribute_name(:tracker) %>
                <%= f.collection_select(:tracker_id, Tracker.all, :id, :name) %>
              </label>
            </p>

            <p>
              <label>
                <%= RecurringTask.human_attribute_name(:time) %>
                <%= f.time_select :time, minute_step: 5 %>
              </label>
              (<%= Time.now.zone %>)
            </p>
          </td>

          <td valign="top" width="30%">
            <p>
              <label>
                <%= l('month') %>

                <% month_names.compact.each_with_index do |m, index| %>
                <% i = index + 1 %>
                <p>
                  <label>
                    <%= m %>
                    <%= check_box_tag 'recurring_task[months][]', i, @schedule.months.include?(i.to_s) %>
                  </label>
                </p>
                <% end %>
              </label>
            </p>
          </td>

          <td valign="top" width="60%">
            <div><%= l('note') %><br><br></div>

            <fieldset class="box tabular">
              <div style="float: left; margin-left: 5em;">
                <p>
                  <label>
                    <input type="radio" name="recurring_task[client_run_type]"
                           value="<%= RecurringTask::RUN_TYPE_M_DAYS %>"<%= ' checked' if @schedule.run_type == RecurringTask::RUN_TYPE_M_DAYS %>> <%= l('month_day') %>
                  </label>
                </p>
                <p>
                  <label>
                    <select id="month_days" name="recurring_task[month_days][]" multiple style="width: 500px; height: 450px;">
                      <% 1.upto(31) do |i| %>
                        <option value="<%= i %>"<%= ' selected' if @schedule.month_days.include?(i.to_s) %>>
                          <%= i %>
                        </option>
                      <% end %>
                      <option value="last_day"<%= ' selected' if @schedule.month_days.include?('last_day') %>>
                        <%= l('last_day') %>
                      </option>
                    </select>
                  </label>
                  <br>
                </p>
              </div>

              <div style="float: left;">
                <p>
                  <label>
                    <input type="radio" name="recurring_task[client_run_type]"
                           value="<%= RecurringTask::RUN_TYPE_W_DAYS %>"<%= ' checked' if @schedule.run_type == RecurringTask::RUN_TYPE_W_DAYS %>> <%= l('week_day') %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:monday) %>
                    <%= f.check_box :monday, class: 'week_day' %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:tuesday) %>
                    <%= f.check_box :tuesday, class: 'week_day' %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:wednesday) %>
                    <%= f.check_box :wednesday, class: 'week_day' %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:thursday) %>
                    <%= f.check_box :thursday, class: 'week_day' %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:friday) %>
                    <%= f.check_box :friday, class: 'week_day' %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:saturday) %>
                    <%= f.check_box :saturday, class: 'week_day' %>
                  </label>
                </p>

                <p>
                  <label>
                    <%= RecurringTask.human_attribute_name(:sunday) %>
                    <%= f.check_box :sunday, class: 'week_day' %>
                  </label>
                </p>
              </div>
            </fieldset>
          </td>
        </tr>
      </table>
    </fieldset>
  </div>

  <div>
    <%= f.submit ( f.object.new_record? ? l(:button_add) : l(:button_change)) %>

    <% if @schedule.persisted? %><%= link_to(l(:button_delete), recurring_task_path(@schedule), method: :delete, data: {confirm: l(:text_are_you_sure)}) %> |
    <% end %>

    <%= link_to(l(:button_cancel), issue_path(@issue)) %>
  </div>
<% end %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/views/recurring_tasks/issues/_bottom.html.erb
################################################################################
<% if controller_name == 'issues' && action_name == 'show' && User.current.allowed_to?(:view_schedule, @project) %>

<hr />

<div class="redmine_recurring_tasks">
  <% if User.current.allowed_to?(:manage_schedule, @project) && (@issue.recurring_task_root.nil? || @issue.recurring_task_root.issue == @issue) %>
    <div class="contextual">
      <% if @issue.recurring_task.present? %>
        <a href="<%= edit_recurring_task_path(@issue.recurring_task_root.id) %>"><%= l(:button_change) %></a>
      <% else %>
        <a href="<%= new_recurring_task_path(issue_id: @issue.id) %>"><%= l(:button_add) %></a>
      <% end %>
    </div>
  <% end %>

  <% RedmineRecurringTasks::IssuePresenter.new(@issue).tap do |issue| %>
    <p><strong><%= l(:schedule) %></strong></p>
    <%= issue.schedule %>
    <%= issue.schedule_template %>
  <% end %>
</div>
<% end %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/views/recurring_tasks/new.html.erb
################################################################################
<h2><%= l(:project_module_redmine_recurring_tasks) %></h2>

<%= render partial: 'form' %>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/app/views/settings/_redmine_recurring_tasks.html.erb
################################################################################
<%
  @settings = ActionController::Parameters.new(@settings)
%>
<p>
  <%= label_tag 'settings[associations]', l(:settings_associations) %>
  <%= select_tag 'settings[associations]',
                 options_for_select(RedmineRecurringTasks.issue_associations, @settings[:associations]),
                 { multiple: true, size: 20, style: 'width: 50%;' } %>
  <p class="notice"><%= l(:settings_associations_warning) %></p>
</p>
<p>
  <%= button_tag l(:button_reset), type: :button, onClick: '$("#settings_associations option:selected").prop("selected", false);' %>
</p>

<p>
  <%= label_tag 'settings[copied_issue_status]', l(:settings_copied_issue_status) %>
  <%= select_tag 'settings[copied_issue_status]',
                 options_for_select([[l(:settings_copy_from_original), 0], *IssueStatus.sorted.map { |status| [status.name, status.id] }], @settings[:copied_issue_status]),
                 include_blank: true %>
</p>
<p>
  <%= label_tag 'settings[use_anonymous_user]', l(:settings_use_anonymous_user) %>
  <%= check_box_tag 'settings[use_anonymous_user]', 1, @settings[:use_anonymous_user] %>
</p>



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/CHANGELOG.md
################################################################################
# 0.3.6

* Fix assigned to error

# 0.3.5

* Add compatibility with Redmine 5.1

# 0.3.4

* Add Translation Into Brazilian Portuguese
* Fix time zone issue

# 0.3.3

* Fix schedule creation

# 0.3.2

* Assign Time.now to copy start_date regardless of due_date presence

# 0.3.1

* Add copy status setting

# 0.3.0

* Improve errors handling
* Adapt for Redmine 4

# 0.2.3

* Use Redmine 3.4-stable in travis with Ruby 2.3 and different time zones
* Use only deep_cloneable to copy issues 

# 0.2.2

* Fix schedule section on issue page
* Fix time chek for DST
* Fix constants loading issue

# 0.2.1

* Copying issues only from active project
* Plugin association removed from settings
* Add warning in plugin settings page
* Add Russian readme

# 0.2.0

* Fix UTC-related issues
* Add setting for anonymous user usage

# 0.1.0

* Add logging errors via logger
* Add ability to choose months and month days
* Change model from WeeklySchedule to RecurringTask
* Fix schedule checking method
* Move schedule to issue details bottom

# 0.0.2

* **(breaking-change)** Rename plugin to RedmineRecurringTasks
* **(breaking-change)** Transfer plugin to Southbridge (http://github.com/centosadmin)
* Make preserve author of issue on copy
* Add relation between Issue and WeeklySchedule 
* Add issue associations to copy in settings
* If issue have due_date then copied issue have relative due_date
* Add watchers to copied issue

# 0.0.1

* Add ability to make issues copies



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/config/locales/de.yml
################################################################################
# German strings go here for Rails i18n
de:
  project_module_redmine_recurring_tasks: Redmine wiederkehrende Aufgaben
  plugin_description: Plugin zum Erstellen von geplanten Aufgaben aus einer Vorlage.
  schedule: Zeitplan
  template: Vorlage

  month: Monat
  week_day: Wochentag
  month_day: Tag des Monats
  last_day: Letzter Tag

  note: Sie k√∂nnen entweder den Tag des Monats oder einen Wochentag w√§hlen, nicht beides. Und wenn Sie f√ºr den Tag des Monats beispielsweise den 31sten Tag gew√§hlt haben, der Monat jedoch nur 28 Tage hat, dann wird die Aufgabe nicht ausgef√ºhrt.

  permission_view_schedule: Zeitplan anzeigen
  permission_manage_schedule: Zeitplan verwalten

  label_add_schedule: Zeitplan hinzuf√ºgen
  label_edit_schedule: Zeitplan bearbeiten

  settings_associations: Problemzuweisungen zum Kopieren angeben
  settings_associations_warning: Achtung! Falsche Einstellungen k√∂nnen die Arbeit des Plugins beeintr√§chtigen. Im Falle eines Problems versuchen Sie alle Optionen zu deaktivieren.
  settings_use_anonymous_user: Anonymen Benutzer beim Kopieren von Problemen verwenden
  settings_copied_issue_status: Status der kopierten Probleme
  settings_copy_from_original: Kopie des urspr√ºnglichen Problems



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/config/locales/en.yml
################################################################################
# English strings go here for Rails i18n
en:
  project_module_redmine_recurring_tasks: Redmine Recurring Tasks
  plugin_description: Plugin for creating scheduled tasks from template.
  schedule: Schedule
  template: Template

  month: Month
  week_day: Day of a week
  month_day: Day of a month
  last_day: Last day

  note: You can choose day of a month or day of a week, not both. And if you chose day of a month, select 31 day, but the month have only 28 days, so task will not run.

  permission_view_schedule: View schedule
  permission_manage_schedule: Manage schedule

  label_add_schedule: Add schedule
  label_edit_schedule: Edit schedule

  settings_associations: Issue associations to copy
  settings_associations_warning: Warning! Incorrect settings may break plugin work. In case of problem try to turn off all options.
  settings_use_anonymous_user: Use anonymous user while copying issues
  settings_copied_issue_status: Copied issues status
  settings_copy_from_original: Copy from original issue



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/config/locales/pt-BR.yml
################################################################################
# Brazilian Portuguese strings go here for Rails i18n
pt-BR:
  project_module_redmine_recurring_tasks: Tarefas Recorrentes do Redmine
  plugin_description: Plugin para criar tarefas agendadas a partir do tamplate.
  schedule: Cronograma
  template: Template

  month: M√™s
  week_day: Dia da semana
  month_day: Dia do m√™s
  last_day: √öltimo dia

  note: Voc√™ pode escolher o dia de um m√™s ou dia da semana, n√£o os dois. E se voc√™ escolheu o dia de um m√™s, selecione 31 dias, mas o m√™s tem apenas 28 dias, portanto, a tarefa n√£o ser√° executada.

  permission_view_schedule: Visualizar cronograma
  permission_manage_schedule: Gerenciar cronograma

  label_add_schedule: Adicionar cronograma
  label_edit_schedule: Editar cronograma

  settings_associations: Emitir associa√ß√µes para copiar
  settings_associations_warning: Aviso! Configura√ß√µes incorretas podem interromper o trabalho do plugin. Em caso de problema tente desligar todas as op√ß√µes.
  settings_use_anonymous_user: Use um usu√°rio an√¥nimo ao copiar problemas
  settings_copied_issue_status: Status de problemas copiados
  settings_copy_from_original: Copiar da edi√ß√£o original



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/config/locales/ru.yml
################################################################################
ru:
  project_module_redmine_recurring_tasks: Redmine Recurring Tasks
  schedule: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
  template: –®–∞–±–ª–æ–Ω
  plugin_description: –ü–ª–∞–≥–∏–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∏–∑ —à–∞–±–ª–æ–Ω–∞

  month: –ú–µ—Å—è—Ü
  week_day: –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏
  month_day: –î–µ–Ω—å –º–µ—Å—è—Ü–∞
  last_day: –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å

  note: –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –∏–ª–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –Ω–æ –Ω–µ –æ–±–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ò –µ—Å–ª–∏ –≤—ã –≤—ã–±–µ—Ä–µ—Ç–µ –¥–µ–Ω—å –º–µ—Å—è—Ü–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ 31, –Ω–æ –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ —Ç–æ–ª—å–∫–æ 28 –¥–Ω–µ–π, —Ç–æ –∑–∞–¥–∞—á–∞ –Ω–µ —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è.

  permission_view_schedule: –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
  permission_manage_schedule: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º

  settings_associations: –°–≤—è–∑–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  settings_associations_warning: –í–Ω–∏–º–∞–Ω–∏–µ! –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–≥—É—Ç –Ω–∞—Ä—É—à–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –ø–ª–∞–≥–∏–Ω–∞. –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω—è—Ç—å –≤—Å–µ –æ–ø—Ü–∏–∏.
  settings_use_anonymous_user: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á
  settings_copied_issue_status: –°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á-–∫–æ–ø–∏–π
  settings_copy_from_original: –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

  activerecord:
    attributes:
      recurring_task:
        sunday: –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
        monday: –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        tuesday: –í—Ç–æ—Ä–Ω–∏–∫
        wednesday: –°—Ä–µ–¥–∞
        thursday: –ß–µ—Ç–≤–µ—Ä–≥
        friday: –ü—è—Ç–Ω–∏—Ü–∞
        saturday: –°—É–±–±–æ—Ç–∞
        time: –í—Ä–µ–º—è



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/config/routes.rb
################################################################################
# Plugin's routes
# See: http://guides.rubyonrails.org/routing.html

resources :recurring_tasks, except: [:index]



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/config/schedule.rb
################################################################################
# Use this file to easily define all of your cron jobs.
#
# It's helpful, but not entirely necessary to understand cron before proceeding.
# http://en.wikipedia.org/wiki/Cron

# Example:
#
# set :output, "/path/to/my/cron_log.log"
#
# every 2.hours do
#   command "/usr/bin/some_great_command"
#   runner "MyModel.some_method"
#   rake "some:great:rake:task"
# end
#
# every 4.days do
#   runner "AnotherModel.prune_old_records"
# end

# Learn more: http://github.com/javan/whenever

every '*/5 * * * *' do
  rake 'redmine_recurring_tasks:exec'
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/db/migrate/001_create_weekly_schedules.rb
################################################################################
class CreateWeeklySchedules < Rails.version < '5.0' ? ActiveRecord::Migration : ActiveRecord::Migration[4.2]
  def change
    create_table :weekly_schedules do |t|
      t.integer  :issue_id,   null: false, index: true
      t.integer  :tracker_id, null: false, index: true
      t.boolean  :sunday,     default: false, null: false
      t.boolean  :monday,     default: false, null: false
      t.boolean  :tuesday,    default: false, null: false
      t.boolean  :wednesday,  default: false, null: false
      t.boolean  :thursday,   default: false, null: false
      t.boolean  :friday,     default: false, null: false
      t.boolean  :saturday,   default: false, null: false
      t.time     :time,       default: '2017-01-01 00:00:00', null: false
      t.datetime :last_try_at

      t.timestamps null: false
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/db/migrate/002_rename_schedules_to_tasks.rb
################################################################################
class RenameSchedulesToTasks < Rails.version < '5.0' ? ActiveRecord::Migration : ActiveRecord::Migration[4.2]
  def change
    rename_table :weekly_schedules, :recurring_tasks
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/db/migrate/003_add_new_intervals_tasks.rb
################################################################################
class AddNewIntervalsTasks < Rails.version < '5.0' ? ActiveRecord::Migration : ActiveRecord::Migration[4.2]
  def change
    change_table :recurring_tasks do |t|
      t.string :months,     default: (1..12).to_a.map(&:to_s).to_json, null: false
      t.string :month_days, default: '[]'
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/Gemfile
################################################################################
gem 'deep_cloneable', git: 'https://github.com/moiristo/deep_cloneable.git',  tag: 'v3.2.0'

group :test do
  gem 'rails-controller-testing'
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/Gemfile.lock
################################################################################
GEM
  specs:
    activemodel (5.0.4)
      activesupport (= 5.0.4)
    activerecord (5.0.4)
      activemodel (= 5.0.4)
      activesupport (= 5.0.4)
      arel (~> 7.0)
    activesupport (5.0.4)
      concurrent-ruby (~> 1.0, >= 1.0.2)
      i18n (~> 0.7)
      minitest (~> 5.1)
      tzinfo (~> 1.1)
    arel (7.1.4)
    concurrent-ruby (1.0.5)
    deep_cloneable (2.2.2)
      activerecord (>= 3.1.0, < 5.2.0)
    i18n (0.8.6)
    minitest (5.10.2)
    thread_safe (0.3.6)
    tzinfo (1.2.3)
      thread_safe (~> 0.1)

PLATFORMS
  ruby

DEPENDENCIES
  deep_cloneable (~> 2.2.2)

BUNDLED WITH
   1.15.2



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/.gitignore
################################################################################
/.idea



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/init.rb
################################################################################
require File.dirname(__FILE__) + '/lib/redmine_recurring_tasks'

reloader = defined?(ActiveSupport::Reloader) ? ActiveSupport::Reloader : ActionDispatch::Reloader
reloader.to_prepare do
  paths = '/lib/redmine_recurring_tasks/{patches/*_patch,hooks/*_hook}.rb'
  Dir.glob(File.dirname(__FILE__) + paths).each do |file|
    require_dependency file
  end
end

Rails.application.config.eager_load_paths += Dir.glob("#{Rails.application.config.root}/plugins/redmine_recurring_tasks/{lib,app/models,app/controllers}")

Redmine::Plugin.register :redmine_recurring_tasks do
  name 'Redmine Recurring Tasks'
  author 'Southbridge'
  description 'Plugin for creating scheduled tasks from template'
  version '0.3.4'
  url 'https://github.com/southbridgeio/redmine_recurring_tasks'
  author_url 'https://github.com/southbridgeio'

  requires_redmine version_or_higher: '3.4'

  settings(
    default: {
      'associations' => RedmineRecurringTasks.issue_associations,
      'use_anonymous_user' => 1
    },
    partial: 'settings/redmine_recurring_tasks'
  )

  project_module :redmine_recurring_tasks do
    permission :view_schedule,   recurring_tasks: :show, read: true
    permission :manage_schedule, recurring_tasks: [:new, :edit, :destroy, :update], require: :loggedin
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/redmine_recurring_tasks/hooks/issue_view_hook.rb
################################################################################
module RedmineRecurringTasks
  module Hooks
    # Issue sidebar hook for show weekly schedule on issue page
    class IssueViewHook < Redmine::Hook::ViewListener
      render_on :view_issues_show_description_bottom, partial: 'recurring_tasks/issues/bottom'
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/redmine_recurring_tasks/issue_checker.rb
################################################################################

module RedmineRecurringTasks
  # Class for check which tasks should be copied
  class IssueChecker
    attr_accessor :settings

    # @param [Hash] redmine plugin settings
    def initialize(settings = nil)
      @settings = settings
    end

    # @return [void]
    def call
      schedules.each do |schedule|
        begin
          schedule.execute(settings['associations'])
        rescue RecurringTask::UnauthorizedError => e
          log_error(e)
          next
        rescue => e
          Airbrake.notify(e) if defined?(Airbrake)
          log_error(e)
          next
        end
      end
    end

    # @return [Array<RecurringTask>] a schedules which should be executed
    def schedules
      RecurringTask.schedules
    end

    private

    def log_error(e)
      logger.error e.to_s
      logger.error e.backtrace.join("\n")
    end

    # @return [Logger] a log class
    def logger
      @logger ||= Logger.new(Rails.root.join('log', 'redmine_recurring_tasks.log'))
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/redmine_recurring_tasks/issue_presenter.rb
################################################################################
module RedmineRecurringTasks
  class IssuePresenter < SimpleDelegator
    include RecurringTasksHelper
    include Rails.application.routes.url_helpers

    def schedule
      return '' if recurring_task.blank?

      if recurring_task_root.run_type == RecurringTask::RUN_TYPE_M_DAYS
        return "#{recurring_task_root.month_days_parsed.join(', ')} #{recurring_task_root.months.map { |m| I18n.t('date.month_names')[m.to_i] }.join(', ')} ‚Äî #{recurring_task_root.time.to_formatted_s(:time)}"
      end

      days = recurring_task_root.days.map do |field|
        <<-HTML
          <li>
            #{RecurringTask.human_attribute_name(field)}, #{recurring_task_root.time.to_formatted_s(:time)}
          </li>
        HTML
      end

      result =
        <<-HTML
          <ul>
            #{days.join}
          </ul>
        HTML
      result.html_safe
    end

    def schedule_template
      root_issue = recurring_task_root&.issue
      return '' if root_issue.blank? || root_issue == __getobj__

      result =
        <<-HTML
          <div>
            #{I18n.t(:template)}:
            #{ActionController::Base.helpers.link_to("#{root_issue.subject.truncate(60)} ##{root_issue.id}", issue_path(root_issue))}
          </div>
        HTML
      result.html_safe
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/redmine_recurring_tasks/issue_presenter.rb.bak
################################################################################
module RedmineRecurringTasks
  class IssuePresenter < SimpleDelegator
    include RecurringTasksHelper
    include Rails.application.routes.url_helpers

    def schedule
      return '' if recurring_task.blank?

      if recurring_task_root.run_type == RecurringTask::RUN_TYPE_M_DAYS
        return "#{recurring_task_root.month_days_parsed.join(', ')} #{recurring_task_root.months.map { |m| I18n.t('date.month_names')[m.to_i] }.join(', ')} ‚Äî #{recurring_task_root.time.to_s(:time)}"
      end

      days = recurring_task_root.days.map do |field|
        <<-HTML
          <li>
            #{RecurringTask.human_attribute_name(field)}, #{recurring_task_root.time.to_s(:time)}
          </li>
        HTML
      end

      result =
        <<-HTML
          <ul>
            #{days.join}
          </ul>
        HTML
      result.html_safe
    end

    def schedule_template
      root_issue = recurring_task_root&.issue
      return '' if root_issue.blank? || root_issue == __getobj__

      result =
        <<-HTML
          <div>
            #{I18n.t(:template)}:
            #{ActionController::Base.helpers.link_to("#{root_issue.subject.truncate(60)} ##{root_issue.id}", issue_path(root_issue))}
          </div>
        HTML
      result.html_safe
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/redmine_recurring_tasks/patches/issue_patch.rb
################################################################################
module RedmineRecurringTasks
  module Patches
    # Patch to make link to RecurringTask
    module IssuePatch
      def self.included(base) # :nodoc:
        base.class_eval do
          

          has_one :recurring_task, dependent: :destroy

          # Return parent issue of children
          def recurring_task_root
            return recurring_task if recurring_task

            RecurringTask.joins(:issue).find_by(issues: {subject:    subject,
                                                          project_id: project_id,
                                                          author_id:  author_id})
          end
        end
      end
    end
  end
end
Issue.send(:include, RedmineRecurringTasks::Patches::IssuePatch)



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/redmine_recurring_tasks.rb
################################################################################
module RedmineRecurringTasks
  def self.issue_associations
    # it's a associations which should be preserved anyway
    default_associations = ['parent', 'project', 'tracker', 'status', 'author', 'assigned_to', 'fixed_version',
                           'priority', 'category', 'journals', 'visible_journals', 'time_entries', 'changesets',
                           'relations_from', 'relations_to', 'attachments', 'custom_values', 'watchers',
                           'watcher_users', 'recurring_task']

    Issue.reflections.keys.dup - default_associations
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/lib/tasks/process.rake
################################################################################
namespace :redmine_recurring_tasks do
  desc 'Run issues check'
  task exec: :environment do
    checker = RedmineRecurringTasks::IssueChecker.new(Setting.plugin_redmine_recurring_tasks)
    checker.call
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/LICENSE
################################################################################
The MIT License (MIT)

Copyright (c) 2013 Hisham Malik

Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
the Software, and to permit persons to whom the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/README.md
################################################################################
[![Rate at redmine.org](http://img.shields.io/badge/rate%20at-redmine.org-blue.svg?style=flat)](http://www.redmine.org/plugins/redmine_recurring_tasks)
# Redmine Recurring Tasks

[![Build Status](https://travis-ci.org/southbridgeio/redmine_recurring_tasks.svg?branch=master)](https://travis-ci.org/southbridgeio/redmine_recurring_tasks)

[–†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è](README-RU.md)

Plugin for creating scheduled tasks from templates.

# Installation

* Ruby 2.2+
* Redmine 3.3+
* Standard plugin installation:

```
cd {REDMINE_ROOT}
git clone https://github.com/southbridgeio/redmine_recurring_tasks.git plugins/redmine_recurring_tasks
bundle install
bundle exec rake redmine:plugins:migrate RAILS_ENV=production
```

# Usage

To use the plugin, you should turn on it in project modules settings. Then you need to go at issue page and you will see
Schedule section with "Add" link, which leads you to recurring settings.

# Run

To run scheduling task you should run rake task

```
cd {REDMINE_ROOT}
bundle exec rake redmine_recurring_tasks:exec RAILS_ENV=production
```

And to do it periodically you may use cron or another external scheduler.

## Schedulers

### Sidekiq-cron

To run sidekiq-cron tasks you should:

- Install redis (*yum install redis*)
- Install plugin [redmine_sidekiq](https://github.com/ogom/redmine_sidekiq)
- Then you can add initialization file. For example

```
# /opt/redmine/config/initializers/zz-cron.rb

class RecurringTaskWorker
  include Sidekiq::Worker

  def perform
    checker = RedmineRecurringTasks::IssueChecker.new(Setting.plugin_redmine_recurring_tasks)
    checker.call
  end
end

cron_job_array = [
  {
    'name'  => 'Weekly schedule worker',
    'class' => 'RecurringTaskWorker',
    'cron'  => '*/5 * * * *'
  }
]

Sidekiq::Cron::Job.load_from_array cron_job_array
```

### Whenever

```
cd {REDMINE_ROOT}
whenever --update-crontab --load-file plugins/redmine_recurring_tasks/config/schedule.rb
```

### Cron manual

```
$ crontab -e
```

And add cron job line

```
*/5 * * * * /bin/bash -l -c 'cd /home/redmine && RAILS_ENV=production bundle exec rake redmine_recurring_tasks:exec'
```

# Settings

If you have any plugins, which for some reason doesn't copying in spawned issues, you can set specific issue associations fields in plugin settings. But be careful ‚Äî this option can break work plugin scheduler.

For example, if you using plugin *Redmine checklists*, you can check "checklists" in RedmineRecurringTasks settings.

# License

[MIT](https://github.com/southbridgeio/redmine_recurring_tasks/blob/master/LICENSE)

# Author of the Plugin

The plugin is designed by [Southbridge](https://southbridge.io)



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/README-RU.md
################################################################################
# Redmine Recurring Tasks

[![Build Status](https://travis-ci.org/southbridgeio/redmine_recurring_tasks.svg?branch=master)](https://travis-ci.org/southbridgeio/redmine_recurring_tasks)

–ü–ª–∞–≥–∏–Ω –¥–ª—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á —Å —à–∞–±–ª–æ–Ω–æ–≤

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞

* Ruby 2.2+
* Redmine 3.3+
* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞:

```
cd {REDMINE_ROOT}
git clone https://github.com/southbridgeio/redmine_recurring_tasks.git plugins/redmine_recurring_tasks
bundle install
bundle exec rake redmine:plugins:migrate RAILS_ENV=production
```

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–ß—Ç–æ–±—ã –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø–ª–∞–≥–∏–Ω–æ–º, –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å –µ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –º–æ–¥—É–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞. –î–∞–ª–µ–µ, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–¥–∞—á–∏
–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–µ–∫—Ü–∏—é "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ" —Å —Å—Å—ã–ª–∫–æ–π "–î–æ–±–∞–≤–∏—Ç—å".

# –ó–∞–ø—É—Å–∫

–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏, –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å rake –∑–∞–¥–∞—á—É

```
cd {REDMINE_ROOT}
bundle exec rake redmine_recurring_tasks:exec RAILS_ENV=production
```

–ò —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏, –º–æ–∂–Ω–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è cron –∏–ª–∏ –¥—Ä—É–≥–∏–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º.

## –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏

### Sidekiq-cron

–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å sidekiq-cron:

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å redis (*yum install redis*)
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω [redmine_sidekiq](https://github.com/ogom/redmine_sidekiq)
- –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –î–ª—è –ø—Ä–∏–º–µ—Ä–∞

```
# /opt/redmine/config/initializers/zz-cron.rb

class RecurringTaskWorker
  include Sidekiq::Worker

  def perform
    checker = RedmineRecurringTasks::IssueChecker.new(Setting.plugin_redmine_recurring_tasks)
    checker.call
  end
end

cron_job_array = [
  {
    'name'  => 'Weekly schedule worker',
    'class' => 'RecurringTaskWorker',
    'cron'  => '*/5 * * * *'
  }
]

Sidekiq::Cron::Job.load_from_array cron_job_array
```

### Whenever

```
cd {REDMINE_ROOT}
whenever --update-crontab --load-file plugins/redmine_recurring_tasks/config/schedule.rb
```

### Cron manual

```
$ crontab -e
```

–î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å cron job

```
*/5 * * * * /bin/bash -l -c 'cd /home/redmine && RAILS_ENV=production bundle exec rake redmine_recurring_tasks:exec'
```

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –¥—Ä—É–≥–∏–µ –ø–ª–∞–≥–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –Ω–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤ –∑–∞–¥–∞—á–∏, —Ç–æ
–≤—ã –º–æ–∂–µ—Ç–µ —É–∫–∞–∑–∞—Ç—å —Å–≤—è–∑–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞. –í–Ω–∏–º–∞–Ω–∏–µ! –≠—Ç–∏ –æ–ø—Ü–∏–∏ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å —Ä–∞–±–æ—Ç—É –ø–ª–∞–≥–∏–Ω–∞.

–î–ª—è –ø—Ä–∏–º–µ—Ä–∞, –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ *Redmine checklists*, –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å "checklists" –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. 

# –õ–∏—Ü–µ–Ω–∑–∏—è

[MIT](https://github.com/southbridgeio/redmine_recurring_tasks/blob/master/LICENSE)

# –ê–≤—Ç–æ—Ä –ø–ª–∞–≥–∏–Ω–∞

–ü–ª–∞–≥–∏–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω [Southbridge](https://southbridge.io)



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/functional/recurring_tasks_controller_test.rb
################################################################################
require File.expand_path('../../test_helper', __FILE__)

class RecurringTasksControllerTest < ActionController::TestCase
  fixtures :projects,
           :users,
           :roles,
           :members,
           :member_roles,
           :trackers,
           :projects_trackers,
           :issue_statuses,
           :issues

  def setup
    Role.find(1).add_permission! :manage_schedule
    Role.find(1).add_permission! :view_schedule
    Project.find(1).enable_module!(:redmine_recurring_tasks)
  end

  def test_new
    @request.session[:user_id] = 2

    with_settings default_language: 'en' do
      if Rails.version < '5.0'
        get :new, issue_id: 1
      else
        get :new, params: { issue_id: 1 }
      end

      assert_response :success
      assert_template 'new'
    end
  end

  def test_new_wrong_issue
    @request.session[:user_id] = 2

    with_settings default_language: 'en' do
      if Rails.version < '5.0'
        get :new, issue_id: 666
      else
        get :new, params: { issue_id: 666 }
      end

      assert_response :not_found
    end
  end

  def test_new_empty_issue
    @request.session[:user_id] = 2

    with_settings default_language: 'en' do
      get :new
      assert_response :not_found
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/integration/lib/redmine_recurring_tasks/hooks/issue_view_hook_test.rb
################################################################################
[EMPTY FILE]



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/support/database.yml.travis
################################################################################
test:
  adapter: postgresql
  encoding: unicode
  pool: 5
  database: travis_ci_test
  user: postgres


################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/test_helper.rb
################################################################################
# Hide ruby warnings
$VERBOSE = nil

# Load the Redmine helper
require File.expand_path(File.dirname(__FILE__) + '/../../../test/test_helper')



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/unit/lib/issue_checker_test.rb
################################################################################
require File.expand_path('../../../test_helper', __FILE__)

class RecurringTaskTest < ActiveSupport::TestCase
  def test_full_days
    recurring_task = RecurringTask.new
    assert recurring_task.days, RecurringTask::DAYS
  end

  def test_partial_days
    recurring_task = RecurringTask.new
    recurring_task.monday = true
    assert recurring_task.days, RecurringTask::DAYS.dup.delete('monday')
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/unit/lib/redmine_recurring_tasks/issue_checker_test.rb
################################################################################
require File.expand_path('../../../../test_helper', __FILE__)

module RedmineRecurringTasks
  class IssueCheckerTest < ActiveSupport::TestCase
    fixtures :projects, :users, :email_addresses, :user_preferences, :members, :member_roles, :roles,
             :groups_users,
             :trackers, :projects_trackers,
             :enabled_modules,
             :versions,
             :issue_statuses, :issue_categories, :issue_relations, :workflows,
             :enumerations,
             :issues, :journals, :journal_details,
             :custom_fields, :custom_fields_projects, :custom_fields_trackers, :custom_values,
             :time_entries

    def test_schedules_return_schedule
      week_day = Time.now.strftime('%A').downcase

      schedule_hash = {
        issue_id: 1,
        tracker_id: 1,
        month_days: []
      }
      schedule_hash[week_day.to_sym] = true
      schedule = RecurringTask.new(schedule_hash)
      schedule.months = nil
      schedule.save!

      assert [schedule] == IssueChecker.new.schedules
    end

    def test_schedules_return_nothing_when_issue_deleted
      new_issue = Issue.new
      new_issue.copy_from(default_issue, attachments: true, subtasks: true, link: false)
      new_issue.save!

      weekly_schedule = RecurringTask.new(issue: new_issue, tracker_id: new_issue.tracker_id)
      RecurringTask::DAYS.each{|d| weekly_schedule.public_send("#{d}=", true)}
      weekly_schedule.save!

      new_issue.destroy!

      assert_equal [], IssueChecker.new.schedules
    end

    def test_schedules_return_nothing
      schedule_hash = {
        issue_id: 1,
        tracker_id: 1
      }
      RecurringTask.create!(schedule_hash)
      assert [] == IssueChecker.new.schedules
    end

    private

    def default_issue
      Issue.first
    end
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/test/unit/recurring_task_test.rb
################################################################################
require File.expand_path('../../test_helper', __FILE__)

class RecurringTaskTest < ActiveSupport::TestCase
  fixtures :projects, :users, :email_addresses, :user_preferences, :members, :member_roles, :roles,
           :groups_users,
           :trackers, :projects_trackers,
           :enabled_modules,
           :versions,
           :issue_statuses, :issue_categories, :issue_relations, :workflows,
           :enumerations,
           :issues, :journals, :journal_details,
           :custom_fields, :custom_fields_projects, :custom_fields_trackers, :custom_values,
           :time_entries

  def test_full_days
    recurring_task = RecurringTask.new
    RecurringTask::DAYS.each{|d| recurring_task.public_send("#{d}=", true)}
    assert recurring_task.days == RecurringTask::DAYS
  end

  def test_partial_days
    recurring_task = RecurringTask.new
    recurring_task.monday = true
    assert recurring_task.days == ['monday']
  end

  def test_issue_id_presence
    recurring_task = RecurringTask.new
    assert recurring_task.invalid?
    assert_equal ['cannot be blank'], recurring_task.errors.messages[:issue_id]
  end

  def test_tracker_id_presence
    recurring_task = RecurringTask.new
    assert recurring_task.invalid?
    assert_equal ['cannot be blank'], recurring_task.errors.messages[:tracker_id]
  end

  def test_copy_has_start_date
    assert default_issue.start_date != default_schedule.copy_issue.start_date
    assert default_schedule.copy_issue.start_date.present?
  end

  def test_copy_has_due_date
    assert default_issue.due_date != default_schedule.copy_issue.due_date
    assert default_schedule.copy_issue.due_date.present?
  end

  def test_copy_has_observer
    issue = Issue.find(1).deep_dup
    issue.add_watcher(User.find(1))
    issue.save!

    schedule = RecurringTask.create!(issue: issue, tracker: issue.tracker)
    copied_issue = schedule.copy_issue

    assert_equal issue.watchers.first.user, User.find(1)
    assert_equal copied_issue.watchers.size, issue.watchers.size
    assert_equal copied_issue.watchers.first.user, issue.watchers.first.user
  end

  def test_copy_has_new_issue
    assert default_issue.id != default_schedule.copy_issue.id
  end

  def test_copy_has_association
    default_issue.create_recurring_task
    copied_issue = default_schedule.copy_issue(:recurring_task)
    assert copied_issue.recurring_task.present?
    assert default_issue.recurring_task.id != copied_issue.recurring_task.id
  end

  def test_copy_status_if_new
    issue = Issue.find(1)
    schedule = RecurringTask.create!(issue: issue, tracker: issue.tracker)
    copied_issue = schedule.copy_issue
    assert_equal issue.status_id, 1
    assert_equal copied_issue.status_id, 1
  end

  def test_copy_status_if_not_new
    issue = Issue.find(8)
    schedule = RecurringTask.create!(issue: issue, tracker: issue.tracker)
    copied_issue = schedule.copy_issue
    assert_equal issue.status_id, 5
    assert_equal copied_issue.status_id, 1
  end

  def test_copy_has_same_subject
    assert default_issue.subject == default_schedule.copy_issue.subject
  end

  def test_copy_has_same_author_when_anonymous_user_not_used
    Setting.plugin_redmine_recurring_tasks = { 'use_anonymous_user' => nil }
    assert default_issue.author_id == default_schedule.copy_issue.author_id
  end

  def test_copy_has_anonymous_author_when_anonymous_user_used
    Setting.plugin_redmine_recurring_tasks = { 'use_anonymous_user' => 1 }
    assert default_schedule.copy_issue.author_id == User.anonymous.id
  end

  def test_copy_when_project_is_closed
    assert closed_project_schedule.copy_issue.nil?
  end

  def test_copy_when_project_is_archived
    assert archived_project_schedule.copy_issue.nil?
  end

  def test_execute
    default_schedule.execute
    assert default_schedule.last_try_at.present?
  end

  def test_month_days
    days = %w(1 2 3)
    default_schedule.month_days = days
    assert default_schedule.save
    assert default_schedule.month_days == days
  end

  def test_run_type_m
    default_schedule.month_days = %w(1 2 3)
    assert default_schedule.save
    assert default_schedule.run_type == RecurringTask::RUN_TYPE_M_DAYS
  end

  def test_run_type_w
    default_schedule.month_days = []
    assert default_schedule.save
    assert default_schedule.run_type == RecurringTask::RUN_TYPE_W_DAYS
  end

  def test_months
    days = %w(1 2 3)
    default_schedule.month_days = days
    assert default_schedule.save
    assert default_schedule.month_days == days
  end

  def test_month_days
    days = %w(last_day)
    default_schedule.month_days = days
    assert default_schedule.save
    assert default_schedule.month_days == days
  end

  def test_month_days_parsed
    days = %w(last_day)
    default_schedule.month_days = days
    assert default_schedule.save
    assert default_schedule.month_days_parsed == [Time.now.end_of_month.day.to_s]
  end

  def test_time_came
    current_time = Time.parse('10:00:00')
    schedule = RecurringTask.new(time: current_time)
    assert schedule.time_came?(current_time)
    assert schedule.time_came?(current_time + 1.minute)
    refute schedule.time_came?(current_time - 1.minute)
    refute schedule.time_came?(current_time + 14.hours)
  end

  def test_time_came_if_last_try_at_is_earlier_than_current_day
    current_time = Time.parse('00:00:00')
    last_try_at = current_time - 1.day
    schedule = RecurringTask.new(time: current_time, last_try_at: last_try_at)
    assert schedule.time_came?(current_time)
  end

  def test_time_came_if_last_try_at_day_is_equal_to_current_day
    current_time = Time.parse('00:00:00')
    last_try_at = current_time + 1.minute
    schedule = RecurringTask.new(time: current_time, last_try_at: last_try_at)
    refute schedule.time_came?(current_time)
  end

  def test_time_came_if_last_try_at_day_is_later_than_current_day
    current_time = Time.parse('00:00:00')
    last_try_at = current_time + 1.day
    schedule = RecurringTask.new(time: current_time, last_try_at: last_try_at)
    refute schedule.time_came?(current_time)
  end

  private

  def default_issue
    Issue.first
  end

  def default_schedule
    @default_schedule ||= RecurringTask.create(issue: default_issue, tracker_id: default_issue.tracker_id)
  end

  def closed_project_schedule
    project = Project.new
    project.status = Project::STATUS_CLOSED
    RecurringTask.new(issue: Issue.new(project: project))
  end

  def archived_project_schedule
    project = Project.new
    project.status = Project::STATUS_ARCHIVED
    RecurringTask.new(issue: Issue.new(project: project))
  end
end



################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/travis.sh
################################################################################
#!/usr/bin/env bash

set -e

if [[ ! "$TESTSPACE" = /* ]] ||
   [[ ! "$PATH_TO_REDMINE" = /* ]] ||
   [[ ! "$REDMINE_VER" = * ]] ||
   [[ ! "$NAME_OF_PLUGIN" = * ]] ||
   [[ ! "$PATH_TO_PLUGIN" = /* ]];
then
  echo "You should set"\
       " TESTSPACE, PATH_TO_REDMINE, REDMINE_VER"\
       " NAME_OF_PLUGIN, PATH_TO_PLUGIN"\
       " environment variables"
  echo "You set:"\
       "$TESTSPACE"\
       "$PATH_TO_REDMINE"\
       "$REDMINE_VER"\
       "$NAME_OF_PLUGIN"\
       "$PATH_TO_PLUGIN"
  exit 1;
fi

export RAILS_ENV=test

export REDMINE_GIT_REPO=git://github.com/redmine/redmine.git
export REDMINE_GIT_TAG=$REDMINE_VER
export BUNDLE_GEMFILE=$PATH_TO_REDMINE/Gemfile

# checkout redmine
git clone $REDMINE_GIT_REPO $PATH_TO_REDMINE
cd $PATH_TO_REDMINE
if [ ! "$REDMINE_GIT_TAG" = "master" ];
then
  git checkout -b $REDMINE_GIT_TAG origin/$REDMINE_GIT_TAG
fi

mv $TESTSPACE/database.yml.travis config/database.yml

# create a link to the backlogs plugin
ln -sf $PATH_TO_PLUGIN plugins/$NAME_OF_PLUGIN

# install gems
bundle install

# run redmine database migrations
bundle exec rake db:migrate

# run plugin database migrations
bundle exec rake redmine:plugins:migrate

bundle exec rake db:structure:dump

# run tests
bundle exec rake redmine:plugins:test NAME=$NAME_OF_PLUGIN


################################################################################
üìÑ FILE: ./storage/redmine/plugins/redmine_recurring_tasks/.travis.yml
################################################################################
language: ruby
rvm:
  - 2.4.9
  - 2.6.5
  - 2.7.2

addons:
  postgresql: "9.4"

env:
  - REDMINE_VER=3.4-stable; TZ=UTC
  - REDMINE_VER=4.1-stable; TZ=Europe/Moscow
  - REDMINE_VER=4.1-stable; TZ=UTC
  - REDMINE_VER=4.1-stable; TZ=Europe/Dublin
  - REDMINE_VER=5.1-stable; TZ=Europe/Moscow
  - REDMINE_VER=5.1-stable; TZ=UTC
  - REDMINE_VER=5.1-stable; TZ=Europe/Dublin

matrix:
  exclude:
  - rvm: 2.7.2
    env: REDMINE_VER=5.1-stable; TZ=UTC

branches:
  only:
    - master
    - develop

install: "echo skip bundle install"

before_script:
  - psql -c 'create database travis_ci_test;' -U postgres

script:
  - export TESTSPACE=`pwd`/testspace
  - export NAME_OF_PLUGIN=redmine_recurring_tasks
  - export PATH_TO_PLUGIN=`pwd`
  - export PATH_TO_REDMINE=$TESTSPACE/redmine
  - mkdir $TESTSPACE
  - cp test/support/* $TESTSPACE/
  - bash -x ./travis.sh



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/app/views/settings/_spent_time_settings.erb
################################################################################
<p>
  <label for="settings_statuses">Status IDs</label>
  <%= text_field_tag 'settings[statuses]', @settings['statuses'] %>
</p>



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/config/locales/en.yml
################################################################################
# English strings go here for Rails i18n
en:
  my_label: "My label"



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/init.rb
################################################################################
require 'redmine'
require File.dirname(__FILE__) + '/lib/issues_controller_patch.rb'

if Rails::VERSION::MAJOR >= 3
  ActionDispatch::Callbacks.to_prepare do
    require_dependency 'issues_controller'
    IssuesController.send(:include, RedmineSpentTimeRequired::Patches::IssuesControllerPatch)
  end
else
  require 'dispatcher'
  Dispatcher.to_prepare do
    require_dependency 'issues_controller'
    IssuesController.send(:include, RedmineSpentTimeRequired::Patches::IssuesControllerPatch)
  end
end

Redmine::Plugin.register :redmine_spent_time_required do
  name 'Redmine Spent Time Required'
  author 'Max Prokopiev'
  description 'Plugin to require adding spent time'
  version '0.0.1'
  url 'http://trs.io/'
  author_url 'http://github.com/juggler'

  settings(:default => {
             'statuses' => '3 5'
           }, :partial => 'settings/spent_time_settings')

end



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/lang/en.yml
################################################################################
# English strings go here
my_label: "My label"



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/lib/issues_controller_patch.rb
################################################################################
module RedmineSpentTimeRequired
  module Patches
    module IssuesControllerPatch
      def self.included(base)
        base.extend(ClassMethods)
        base.send(:include, InstanceMethods)
        base.class_eval do
          unloadable
          alias_method_chain :update, :check_spent_time
        end
      end

      module ClassMethods
      end

      module InstanceMethods
        def update_with_check_spent_time
          allowed_statuses = Setting.plugin_redmine_spent_time_required['statuses'].scan(/\d+/)
          current_status = params[:issue][:status_id]
          if ((params[:time_entry] != nil) && (params[:time_entry][:hours] == "") && (allowed_statuses.member?(current_status.to_s)))
            flash[:error] = "Spent time required"
            find_issue
            update_issue_from_params
            render(:action => 'edit') and return
          else
            update_without_check_spent_time
          end
        end
      end

    end
  end
end



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/README.rdoc
################################################################################
= Spent time required

A Redmine plugin to require adding spent time

== Usage

After setup it will automatically start to require issue spent time.

== Installation and Setup

1. Follow the Redmine plugin installation steps at: http://www.redmine.org/wiki/redmine/Plugins 
2. Restart your Redmine web servers (e.g. mongrel, thin, mod_rails)
3. Go to Administartion -> Plugins, find this plugin and click Configure. Then set issue status ids in the transition of which you want to require spent time.

= Requrements
* Redmine 1.2.1 or later (may work on earlier verisons, but not tested for it)

= Author
Max Prokopiev
¬© 2011 TeamRocketScience. http://trs.io



################################################################################
üìÑ FILE: ./storage/shared/redmine_spent_time_required-master/test/test_helper.rb
################################################################################
# Load the normal Rails helper
require File.expand_path(File.dirname(__FILE__) + '/../../../../test/test_helper')

# Ensure that we are using the temporary fixture path
Engines::Testing.set_fixture_path



