#!/bin/bash

# ==============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å–ª–æ–∂–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
# ==============================================================================

# 1. –¢–æ—á–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞)
# –í–ê–ñ–ù–û: –ü—É—Ç–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "./" –∏ –±—ã—Ç—å –±–µ–∑ —Å–ª–µ—à–∞ –≤ –∫–æ–Ω—Ü–µ
EXCLUDE_PATHS=(
    "./legacy"
    "./logs"
    "./storage/redmine/attachment_files"
    "./storage/redmine/log"
    "./storage/redmine/themes"
)

# 2. –ò–º–µ–Ω–∞ –ø–∞–ø–æ–∫ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è (–±—É–¥—É—Ç –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤–µ–∑–¥–µ, –Ω–∞ –ª—é–±–æ–π –≥–ª—É–±–∏–Ω–µ)
EXCLUDE_NAMES=(
    ".git"
    ".idea"
    "node_modules"
    "__pycache__"
)

# –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è find
FIND_ARGS=()

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—É—Ç–µ–π (-path)
for path in "${EXCLUDE_PATHS[@]}"; do
    FIND_ARGS+=( "-path" "$path" "-prune" "-o" )
done

# –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∏–º–µ–Ω (-name)
for name in "${EXCLUDE_NAMES[@]}"; do
    FIND_ARGS+=( "-name" "$name" "-prune" "-o" )
done

# ==============================================================================
# –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –∏ –≤—ã–≤–æ–¥–∞
# ==============================================================================

# find . 
#   \( ...–∏—Å–∫–ª—é—á–µ–Ω–∏—è... -false \) -o   <-- –±–ª–æ–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
#   -type f -print0                    <-- –µ—Å–ª–∏ –Ω–µ –∏—Å–∫–ª—é—á–µ–Ω–æ, –∏ —ç—Ç–æ —Ñ–∞–π–ª, –≤—ã–≤–æ–¥–∏–º
#
find . \( "${FIND_ARGS[@]}" -false \) -o -type f -print0 | sort -z | while IFS= read -r -d '' file; do
    
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–∞–º —Ñ–∞–π–ª —Å–∫—Ä–∏–ø—Ç–∞
    if [[ "$file" == "./$(basename "$0")" ]]; then continue; fi

    echo "################################################################################"
    echo "üìÑ FILE: $file"
    echo "################################################################################"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –±–∏–Ω–∞—Ä–Ω—ã–π ‚Äî –Ω–µ –≤—ã–≤–æ–¥–∏–º –º—É—Å–æ—Ä
    if [[ -s "$file" ]]; then
        # grep -Iq . –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–º
        if grep -Iq . "$file"; then
            cat "$file"
        else
            echo "[BINARY FILE - SKIPPED]"
        fi
    else
         echo "[EMPTY FILE]"
    fi

    echo -e "\n\n"
done
