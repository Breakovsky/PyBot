{% extends "base.html" %}

{% block page_title %}Inventory{% endblock %}

{% block content %}
<div x-data="inventoryApp()" class="space-y-6">
    
    <!-- Top Stats & Search -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-x-3">
            <span class="inline-flex items-center rounded-md bg-indigo-400/10 px-2 py-1 text-xs font-medium text-indigo-400 ring-1 ring-inset ring-indigo-400/30">
                <span x-text="filteredEmployees.length"></span> —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            </span>
        </div>
        
        <div class="w-full max-w-sm">
            <div class="relative rounded-md shadow-sm">
                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                    <svg class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                    </svg>
                </div>
                <input type="text" x-model="searchQuery" @input="filterEmployees" 
                       class="block w-full rounded-md border-0 py-1.5 pl-10 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:text-slate-200 dark:ring-slate-700 dark:placeholder:text-slate-500 sm:text-sm sm:leading-6" 
                       placeholder="Search employees... (‚åòK)">
            </div>
        </div>
    </div>

    <!-- Tabs & Filters -->
    <div class="border-b border-slate-200 dark:border-slate-700">
        <div class="sm:flex sm:items-baseline sm:justify-between">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button @click="activeTab = 'inventory'" 
                        :class="activeTab === 'inventory' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300'"
                        class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">
                    üìã –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                </button>
                <button @click="activeTab = 'free_ws'; calculateFreeWS();" 
                        :class="activeTab === 'free_ws' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300'"
                        class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">
                    üÜì –°–≤–æ–±–æ–¥–Ω—ã–µ WS
                </button>
            </nav>

            <div class="mt-4 sm:ml-10 sm:mt-0">
                <div class="flex items-center space-x-2">
                    <button @click="filterCompany = 'all'; filterEmployees();" 
                            :class="filterCompany === 'all' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'"
                            class="rounded-md px-3 py-1.5 text-sm font-medium transition-colors">
                        –í—Å–µ
                    </button>
                    <button @click="filterCompany = 'MOBI'; filterEmployees();" 
                            :class="filterCompany === 'MOBI' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'"
                            class="rounded-md px-3 py-1.5 text-sm font-medium transition-colors">
                        MOBI
                    </button>
                    <button @click="filterCompany = 'EGR'; filterEmployees();" 
                            :class="filterCompany === 'EGR' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'"
                            class="rounded-md px-3 py-1.5 text-sm font-medium transition-colors">
                        EGR
                    </button>
                    <button @click="filterCompany = 'NIK'; filterEmployees();" 
                            :class="filterCompany === 'NIK' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'"
                            class="rounded-md px-3 py-1.5 text-sm font-medium transition-colors">
                        NIK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Table -->
    <div x-show="activeTab === 'inventory'" class="flow-root">
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
                    <table class="min-w-full divide-y divide-slate-300 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-800">
                            <tr>
                                <th scope="col" @click="sortBy('id')" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 sm:pl-6 cursor-pointer select-none group">
                                    <div class="flex items-center gap-2">
                                        #
                                        <span class="flex flex-col">
                                            <svg x-show="sortField === 'id' && sortDirection === 'asc'" class="h-3 w-3 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z"/></svg>
                                            <svg x-show="sortField === 'id' && sortDirection === 'desc'" class="h-3 w-3 text-indigo-500" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                                        </span>
                                    </div>
                                </th>
                                <th scope="col" @click="sortBy('full_name')" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 cursor-pointer select-none">Name</th>
                                <th scope="col" @click="sortBy('company')" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 cursor-pointer select-none">Company</th>
                                <th scope="col" @click="sortBy('department')" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 cursor-pointer select-none">Dept</th>
                                <th scope="col" @click="sortBy('location')" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 cursor-pointer select-none">Location</th>
                                <th scope="col" @click="sortBy('workstation')" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 cursor-pointer select-none">WS</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200">Phone</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200">Device</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900 dark:text-slate-200 text-center">Status</th>
                                <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6"><span class="sr-only">Actions</span></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700 bg-white dark:bg-slate-900">
                            <template x-for="(emp, index) in filteredEmployees" :key="emp.id">
                                <tr class="even:bg-slate-50 dark:even:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer transition-colors"
                                    :class="{ 'opacity-50': !emp.is_active }"
                                    @click="openDrawer(emp)">
                                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-slate-500 dark:text-slate-400 sm:pl-6" x-text="emp.id"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="h-8 w-8 flex-shrink-0 rounded-full bg-indigo-600 flex items-center justify-center">
                                                <span class="text-xs font-medium text-white" x-text="getInitials(emp.full_name)"></span>
                                            </div>
                                            <div class="ml-4">
                                                <div class="font-medium text-slate-900 dark:text-slate-200" x-text="emp.full_name"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400">
                                        <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset"
                                              :class="{
                                                  'bg-blue-50 text-blue-700 ring-blue-700/10 dark:bg-blue-900/30 dark:text-blue-400': emp.company === 'MOBI',
                                                  'bg-purple-50 text-purple-700 ring-purple-700/10 dark:bg-purple-900/30 dark:text-purple-400': emp.company === 'EGR',
                                                  'bg-orange-50 text-orange-700 ring-orange-700/10 dark:bg-orange-900/30 dark:text-orange-400': emp.company === 'NIK',
                                                  'bg-slate-50 text-slate-600 ring-slate-500/10 dark:bg-slate-800 dark:text-slate-400': !['MOBI', 'EGR', 'NIK'].includes(emp.company)
                                              }"
                                              x-text="emp.company || 'N/A'"></span>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400" x-text="emp.department || '‚Äî'"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400" x-text="emp.location || '‚Äî'"></td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm">
                                        <code class="rounded bg-slate-100 dark:bg-slate-700 px-[0.3rem] py-[0.2rem] font-mono text-xs font-semibold text-slate-900 dark:text-slate-200" x-text="emp.workstation || '‚Äî'"></code>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400">
                                        <div class="flex items-center gap-1">
                                            <span x-text="emp.internal_phone || '‚Äî'"></span>
                                            <span x-show="emp.phone_type === 'TA'" title="Telephone" class="text-xs">üìû</span>
                                            <span x-show="emp.phone_type === 'MicroSIP'" title="Softphone" class="text-xs">üíª</span>
                                        </div>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 dark:text-slate-400">
                                        <span x-text="getDeviceIcon(emp.device_type) + ' ' + (emp.device_type || '')"></span>
                                    </td>
                                    <td class="whitespace-nowrap px-3 py-4 text-sm text-center">
                                        <div class="flex justify-center gap-1">
                                            <span class="h-2 w-2 rounded-full" :class="emp.has_ad ? 'bg-green-400' : 'bg-slate-200 dark:bg-slate-600'" title="AD"></span>
                                            <span class="h-2 w-2 rounded-full" :class="emp.has_drweb ? 'bg-green-400' : 'bg-slate-200 dark:bg-slate-600'" title="Dr.Web"></span>
                                            <span class="h-2 w-2 rounded-full" :class="emp.has_zabbix ? 'bg-green-400' : 'bg-slate-200 dark:bg-slate-600'" title="Zabbix"></span>
                                        </div>
                                    </td>
                                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                        <button @click.stop="openDrawer(emp)" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">Edit</button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="filteredEmployees.length === 0">
                                <td colspan="10" class="py-10 text-center text-slate-500 dark:text-slate-400">
                                    No employees found.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Free WS Tab -->
    <div x-show="activeTab === 'free_ws'" class="space-y-6">
        <div class="rounded-xl bg-white dark:bg-slate-800 shadow-sm ring-1 ring-slate-900/5 dark:ring-slate-700 p-6">
             <div class="flex items-center justify-between mb-6">
                <h3 class="text-base font-semibold leading-6 text-slate-900 dark:text-slate-200">Available Workstations</h3>
                <button @click="calculateFreeWS()" class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Refresh</button>
            </div>
            
            <div x-show="freeWSGroups.length === 0" class="text-center py-10 text-slate-500">
                No free workstations found.
            </div>

            <template x-for="group in freeWSGroups" :key="group.prefix">
                <div class="mb-8 last:mb-0">
                    <h4 class="text-sm font-medium text-slate-500 dark:text-slate-400 mb-3 border-b border-slate-100 dark:border-slate-700 pb-2">
                        <span class="text-slate-900 dark:text-slate-200 font-bold" x-text="group.prefix"></span>
                        <span class="ml-2">
                            (Free: <span x-text="group.free.length"></span> / <span x-text="group.total"></span>)
                            <span x-show="group.range" class="ml-2 text-xs opacity-75" x-text="group.range"></span>
                        </span>
                    </h4>
                    <div class="grid grid-cols-6 gap-2 sm:grid-cols-8 md:grid-cols-10 lg:grid-cols-12">
                        <template x-for="ws in group.free" :key="ws">
                            <div class="rounded bg-green-50 dark:bg-green-900/20 px-2 py-1 text-center text-xs font-mono font-medium text-green-700 dark:text-green-400 ring-1 ring-inset ring-green-600/20">
                                <span x-text="ws"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Drawer -->
    <div x-show="drawerOpen" class="relative z-50" aria-labelledby="slide-over-title" role="dialog" aria-modal="true" style="display: none;">
        <div x-show="drawerOpen" 
             x-transition:enter="ease-in-out duration-500" 
             x-transition:enter-start="opacity-0" 
             x-transition:enter-end="opacity-100" 
             x-transition:leave="ease-in-out duration-500" 
             x-transition:leave-start="opacity-100" 
             x-transition:leave-end="opacity-0" 
             class="fixed inset-0 bg-slate-900/75 backdrop-blur-sm transition-opacity"></div>

        <div class="fixed inset-0 overflow-hidden">
            <div class="absolute inset-0 overflow-hidden">
                <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                    <div x-show="drawerOpen" 
                         x-transition:enter="transform transition ease-in-out duration-500 sm:duration-700" 
                         x-transition:enter-start="translate-x-full" 
                         x-transition:enter-end="translate-x-0" 
                         x-transition:leave="transform transition ease-in-out duration-500 sm:duration-700" 
                         x-transition:leave-start="translate-x-0" 
                         x-transition:leave-end="translate-x-full" 
                         class="pointer-events-auto w-screen max-w-md" 
                         @click.away="drawerOpen = false">
                        
                        <div class="flex h-full flex-col overflow-y-scroll bg-white dark:bg-slate-900 shadow-xl">
                            <div class="px-4 py-6 sm:px-6 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                                <div class="flex items-start justify-between">
                                    <h2 class="text-base font-semibold leading-6 text-slate-900 dark:text-slate-100" id="slide-over-title">
                                        <span x-text="editMode ? 'Edit Employee' : 'Employee Details'"></span>
                                    </h2>
                                    <div class="ml-3 flex h-7 items-center gap-3">
                                        <button @click="editMode = !editMode" type="button" class="rounded-md bg-indigo-600 px-2.5 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                                            <span x-text="editMode ? 'Save' : 'Edit'"></span>
                                        </button>
                                        <button @click="drawerOpen = false" type="button" class="relative rounded-md text-slate-400 hover:text-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                            <span class="absolute -inset-2.5"></span>
                                            <span class="sr-only">Close panel</span>
                                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-4">
                                     <div class="flex items-center">
                                        <div class="h-12 w-12 flex-shrink-0 rounded-full bg-indigo-600 flex items-center justify-center">
                                            <span class="text-lg font-bold text-white" x-text="selectedEmployee ? getInitials(selectedEmployee.full_name) : ''"></span>
                                        </div>
                                        <div class="ml-4">
                                            <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100" x-text="selectedEmployee?.full_name"></h3>
                                            <p class="text-sm text-slate-500 dark:text-slate-400" x-text="selectedEmployee?.department || 'No Department'"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Drawer Tabs -->
                            <div class="border-b border-slate-200 dark:border-slate-700">
                                <nav class="-mb-px flex space-x-6 px-6" aria-label="Tabs">
                                    <button @click="drawerActiveTab = 'general'" :class="drawerActiveTab === 'general' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400'" class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">General</button>
                                    <button @click="drawerActiveTab = 'hardware'" :class="drawerActiveTab === 'hardware' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400'" class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Hardware</button>
                                    <button @click="drawerActiveTab = 'software'" :class="drawerActiveTab === 'software' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400'" class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Software</button>
                                    <button @click="drawerActiveTab = 'notes'" :class="drawerActiveTab === 'notes' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-slate-500 hover:border-slate-300 hover:text-slate-700 dark:text-slate-400'" class="whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Notes</button>
                                </nav>
                            </div>

                            <div class="relative flex-1 px-4 py-6 sm:px-6 space-y-6">
                                
                                <!-- General Tab -->
                                <div x-show="drawerActiveTab === 'general'" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Full Name</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.full_name" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50 disabled:bg-slate-100 dark:disabled:bg-slate-800">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Company</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.company" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Department</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.department" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Location</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.location" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Workstation</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.workstation" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                     <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">AD Login</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.ad_login" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                </div>

                                <!-- Hardware Tab -->
                                <div x-show="drawerActiveTab === 'hardware'" class="space-y-4">
                                     <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Device Type</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.device_type" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">CPU</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.specs_cpu" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">RAM</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.specs_ram" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">GPU</label>
                                        <div class="mt-2">
                                            <input type="text" x-model="selectedEmployee.specs_gpu" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Software Tab -->
                                <div x-show="drawerActiveTab === 'software'" class="space-y-4">
                                    <div class="flex items-center justify-between py-3">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Active Directory</span>
                                            <span class="text-sm text-slate-500">Domain access enabled</span>
                                        </div>
                                        <button type="button" 
                                                @click="if(editMode) selectedEmployee.has_ad = !selectedEmployee.has_ad"
                                                :class="selectedEmployee.has_ad ? 'bg-indigo-600' : 'bg-slate-200 dark:bg-slate-700'" 
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2" 
                                                role="switch" 
                                                :aria-checked="selectedEmployee.has_ad">
                                            <span aria-hidden="true" 
                                                  :class="selectedEmployee.has_ad ? 'translate-x-5' : 'translate-x-0'" 
                                                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                        </button>
                                    </div>
                                     <div class="flex items-center justify-between py-3">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Dr.Web</span>
                                            <span class="text-sm text-slate-500">Antivirus protection</span>
                                        </div>
                                        <button type="button" 
                                                @click="if(editMode) selectedEmployee.has_drweb = !selectedEmployee.has_drweb"
                                                :class="selectedEmployee.has_drweb ? 'bg-indigo-600' : 'bg-slate-200 dark:bg-slate-700'" 
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2" 
                                                role="switch" 
                                                :aria-checked="selectedEmployee.has_drweb">
                                            <span aria-hidden="true" 
                                                  :class="selectedEmployee.has_drweb ? 'translate-x-5' : 'translate-x-0'" 
                                                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between py-3">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Zabbix</span>
                                            <span class="text-sm text-slate-500">System monitoring</span>
                                        </div>
                                        <button type="button" 
                                                @click="if(editMode) selectedEmployee.has_zabbix = !selectedEmployee.has_zabbix"
                                                :class="selectedEmployee.has_zabbix ? 'bg-indigo-600' : 'bg-slate-200 dark:bg-slate-700'" 
                                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2" 
                                                role="switch" 
                                                :aria-checked="selectedEmployee.has_zabbix">
                                            <span aria-hidden="true" 
                                                  :class="selectedEmployee.has_zabbix ? 'translate-x-5' : 'translate-x-0'" 
                                                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Notes Tab -->
                                <div x-show="drawerActiveTab === 'notes'" class="space-y-4">
                                     <div>
                                        <label class="block text-sm font-medium leading-6 text-slate-900 dark:text-slate-200">Notes</label>
                                        <div class="mt-2">
                                            <textarea rows="10" x-model="selectedEmployee.notes" :disabled="!editMode" class="block w-full rounded-md border-0 py-1.5 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-slate-800 dark:ring-slate-700 dark:text-white sm:text-sm sm:leading-6 disabled:opacity-50"></textarea>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function inventoryApp() {
        return {
            employees: {{ employees | tojson }},
            filteredEmployees: [],
            searchQuery: '',
            drawerOpen: false,
            selectedEmployee: null,
            editMode: false,
            activeTab: 'inventory',
            drawerActiveTab: 'general',
            filterCompany: 'all',
            freeWSGroups: [],
            
            // Sort state
            sortField: 'id',
            sortDirection: 'asc',
            
            init() {
                this.applyFiltersAndSort();
            },
            
            toggleTheme() {
                // Handled by layout() in base.html but if needed for local logic...
            },
            
            sortBy(field) {
                if (this.sortField === field) {
                    this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortField = field;
                    this.sortDirection = 'asc';
                }
                this.applyFiltersAndSort();
            },
            
            filterEmployees() {
                this.applyFiltersAndSort();
            },
            
            applyFiltersAndSort() {
                let results = this.employees;
                
                // Text search
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    results = results.filter(emp => 
                        (emp.full_name && emp.full_name.toLowerCase().includes(query)) ||
                        (emp.workstation && emp.workstation.toLowerCase().includes(query)) ||
                        (emp.internal_phone && emp.internal_phone.includes(query)) ||
                        (emp.email && emp.email.toLowerCase().includes(query)) ||
                        (emp.department && emp.department.toLowerCase().includes(query)) ||
                        (emp.company && emp.company.toLowerCase().includes(query))
                    );
                }
                
                // Company filter
                if (this.filterCompany !== 'all') {
                    results = results.filter(emp => emp.company === this.filterCompany);
                }
                
                // Sort
                if (this.sortField) {
                    results = [...results].sort((a, b) => {
                        let aVal = a[this.sortField];
                        let bVal = b[this.sortField];
                        
                        if (aVal == null) aVal = '';
                        if (bVal == null) bVal = '';
                        
                        if (this.sortField === 'id') {
                            aVal = parseInt(aVal) || 0;
                            bVal = parseInt(bVal) || 0;
                            return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                        }
                        
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                        
                        if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
                        if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                
                this.filteredEmployees = results;
            },
            
            openDrawer(employee) {
                this.selectedEmployee = JSON.parse(JSON.stringify(employee));
                this.drawerOpen = true;
                this.editMode = false;
                this.drawerActiveTab = 'general';
            },
            
            getInitials(name) {
                if (!name) return '?';
                const parts = name.split(' ');
                if (parts.length >= 2) {
                    return (parts[0][0] + parts[1][0]).toUpperCase();
                }
                return name.substring(0, 2).toUpperCase();
            },
            
            getDeviceIcon(type) {
                const icons = {
                    'Laptop': 'üíª',
                    'PC': 'üñ•Ô∏è',
                    'Monoblock': 'üñ•',
                    'Server': 'üóÑÔ∏è',
                    'Other': 'üì¶'
                };
                return icons[type] || 'üì¶';
            },
            
            calculateFreeWS() {
                const wsPatterns = [
                    { prefix: 'WS', pattern: /^WS(\d+)$/i },
                    { prefix: 'PWS', pattern: /^PWS(\d+)$/i },
                    { prefix: 'NIK', pattern: /^NIK(\d+)$/i },
                    { prefix: 'MRF', pattern: /^MRF(\d+)$/i },
                    { prefix: 'PC', pattern: /^PC(\d+)$/i },
                    { prefix: 'WS-', pattern: /^WS-(\d+)$/i }
                ];
                
                const occupied = new Set();
                const wsFormats = {}; 
                
                this.employees.forEach(emp => {
                    if (emp.workstation) {
                        const ws = emp.workstation.toUpperCase();
                        occupied.add(ws);
                        wsPatterns.forEach(({ prefix, pattern }) => {
                            const match = ws.match(pattern);
                            if (match) {
                                const num = parseInt(match[1]);
                                if (!wsFormats[prefix]) wsFormats[prefix] = {};
                                wsFormats[prefix][num] = match[0];
                            }
                        });
                    }
                });
                
                const groups = {};
                
                wsPatterns.forEach(({ prefix, pattern }) => {
                    const numbers = [];
                    const formatMap = {};
                    
                    occupied.forEach(ws => {
                        const match = ws.match(pattern);
                        if (match) {
                            const num = parseInt(match[1]);
                            numbers.push(num);
                            formatMap[num] = match[0];
                        }
                    });
                    
                    if (numbers.length > 0) {
                        numbers.sort((a, b) => a - b);
                        const min = numbers[0];
                        const max = numbers[numbers.length - 1];
                        
                        let padding = 0;
                        if (formatMap[min]) {
                            const original = formatMap[min];
                            const numInOriginal = original.match(/\d+/)?.[0];
                            if (numInOriginal) padding = numInOriginal.length;
                        }
                        if (padding === 0) padding = 3;
                        
                        const formatWS = (num) => {
                            const numStr = String(num).padStart(padding, '0');
                            return prefix.endsWith('-') ? `${prefix}${numStr}` : `${prefix}${numStr}`;
                        };
                        
                        const free = [];
                        for (let i = min; i <= max; i++) {
                            const wsName = formatWS(i);
                            if (!occupied.has(wsName)) {
                                free.push(wsName);
                            }
                        }
                         // Check gaps before min
                        for (let i = Math.max(1, min - 50); i < min; i++) {
                            const wsName = formatWS(i);
                            if (!occupied.has(wsName)) {
                                free.push(wsName);
                            }
                        }
                        
                        if (free.length > 0) {
                            groups[prefix] = {
                                prefix: prefix,
                                occupied: numbers.length,
                                free: free.sort((a, b) => {
                                    const numA = parseInt(a.match(/\d+/)?.[0] || '0');
                                    const numB = parseInt(b.match(/\d+/)?.[0] || '0');
                                    return numA - numB;
                                }),
                                total: max - min + 1,
                                range: `${formatWS(min)} - ${formatWS(max)}`
                            };
                        }
                    }
                });
                
                this.freeWSGroups = Object.values(groups).sort((a, b) => a.prefix.localeCompare(b.prefix));
            }
        }
    }
</script>
{% endblock %}
